<!DOCTYPE html>
<html lang="en">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <title>
  Recommender Systems &amp; Collaborative Filtering · Mike Harmon
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Mike Harmon">
<meta name="description" content="
  Contents
  
    
    Link to heading
  


1. Introduction
2. Preprocessing &amp; Basic Statistics
3. User-User Collaborative Filtering
4. Next Steps


  Introduction 
  
    
    Link to heading
  


Recommender systems are one of the most important applications of data science across the consumer-facing technology industry.  They are used almost everywhere; examples are &lsquo;Amazon’s Recommended Items&rsquo;, Internet Radio stations, and suggested videos on Netflix.  There are two general approaches to recommender systems:">
<meta name="keywords" content="blog,data,ai">



  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Recommender Systems & Collaborative Filtering">
  <meta name="twitter:description" content="Contents Link to heading 1. Introduction
2. Preprocessing &amp; Basic Statistics
3. User-User Collaborative Filtering
4. Next Steps
Introduction Link to heading Recommender systems are one of the most important applications of data science across the consumer-facing technology industry. They are used almost everywhere; examples are ‘Amazon’s Recommended Items’, Internet Radio stations, and suggested videos on Netflix. There are two general approaches to recommender systems:">

<meta property="og:url" content="http://localhost:1313/posts/recommender/">
  <meta property="og:site_name" content="Mike Harmon">
  <meta property="og:title" content="Recommender Systems & Collaborative Filtering">
  <meta property="og:description" content="Contents Link to heading 1. Introduction
2. Preprocessing &amp; Basic Statistics
3. User-User Collaborative Filtering
4. Next Steps
Introduction Link to heading Recommender systems are one of the most important applications of data science across the consumer-facing technology industry. They are used almost everywhere; examples are ‘Amazon’s Recommended Items’, Internet Radio stations, and suggested videos on Netflix. There are two general approaches to recommender systems:">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2017-04-19T00:00:00+00:00">
    <meta property="article:modified_time" content="2017-04-19T00:00:00+00:00">
    <meta property="article:tag" content="Collaborative Filtering">




<link rel="canonical" href="http://localhost:1313/posts/recommender/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.css" media="screen">






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.css" media="screen">
  



 


  
  
    
    
    <link rel="stylesheet" href="/scss/coder.css" media="screen">
  

  
  
    
    
    <link rel="stylesheet" href="/scss/coder-dark.css" media="screen">
  



<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="http://localhost:1313/">
      Mike Harmon
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/about">About</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts/">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/projects/">Projects</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/contact/">Contact me</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="http://localhost:1313/posts/recommender/">
              Recommender Systems &amp; Collaborative Filtering
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2017-04-19T00:00:00Z">
                April 19, 2017
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              15-minute read
            </span>
          </div>
          <div class="authors">
  <i class="fa-solid fa-user" aria-hidden="true"></i>
    <a href="/authors/mike-harmon/">Mike Harmon</a></div>

          
          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/tags/collaborative-filtering/">Collaborative Filtering</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <h2 id="contents">
  Contents
  <a class="heading-link" href="#contents">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<hr>
<p><strong><a href="#first-bullet" >1. Introduction</a></strong></p>
<p><strong><a href="#second-bullet" >2. Preprocessing &amp; Basic Statistics</a></strong></p>
<p><strong><a href="#third-bullet" >3. User-User Collaborative Filtering</a></strong></p>
<p><strong><a href="#fourth-bullet" >4. Next Steps</a></strong></p>
<hr>
<h2 id="introduction">
  Introduction <a class="anchor" id="first-bullet"></a>
  <a class="heading-link" href="#introduction">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<hr>
<p>Recommender systems are one of the most important applications of data science across the consumer-facing technology industry.  They are used almost everywhere; examples are &lsquo;Amazon’s Recommended Items&rsquo;, Internet Radio stations, and suggested videos on Netflix.  There are two general approaches to recommender systems:</p>
<ol>
<li>
<p><a href="https://en.wikipedia.org/wiki/Collaborative_filtering">Collaborative filtering</a></p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Recommender_system#Content-based_filtering">Content-based filtering</a></p>
</li>
</ol>
<p>Collaborative filtering is a method of recommending products to customers by using their past behaviors or product ratings, as well as similar decisions by other customers to predict which items might be appealing to the original customers. Content-based filtering suggests products to customers by using the characteristics of an item they have selected in the past in order to recommend additional items with similar properties.  There are advantages and disadvantages to both of these methods.</p>
<p>Collaborative filtering suffers from the cold start problem, meaning it requires a certain threshold of user input in order to make any recommendations. Content-based filtering, on the other hand, only requires one data point&ndash;for example, one item that a specific user has purchased&ndash;in order to produce suggestions. However, content-based filtering is limited in scope and in the relevance of its results, since it can only recommend products that are similar to the original product selected. Collaborative filtering can overcome this limitation by suggesting products not necessarily similar to previous products that user has selected, but that similar users have found appealing. Because of this ability to accurately recommend complex items without needing to understand the qualities of the items themselves, collaborative filtering is the more widely used method, and thus the focus of this blog post. Collaborative filtering is also much more popular for web-based recommendations where the data is sparse, i.e., where there is a limited number of reviews by each user or for a particular product.</p>
<hr>
<h2 id="collaborative-filtering">
  Collaborative Filtering
  <a class="heading-link" href="#collaborative-filtering">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<hr>
<p>As mentioned previously, in collaborative filtering we do not need to know much about the products or the customers.  We just need to know need to know how many unique products and customers there as well as how the customers rated the products.  This information is stored in a user-item table, where the ratings are the entries in the table. An example of a user-item table can be seen below,</p>
<center>
<img src="https://github.com/mdh266/RecommenderSystems/blob/master/images/table.jpg?raw=1">
</center>
<p>The ratings matrix is another representation of the user-item table where each user and item have been assigned an unique integer value. The general rating matrix <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="bold">R</mtext></mrow><annotation encoding="application/x-tex">\textbf{R}</annotation></semantics></math></span>
 is in <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>R</mi><mrow><msub><mi>n</mi><mi>u</mi></msub><mo>×</mo><msub><mi>n</mi><mi>i</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex"> R^{n_{u} \times n_{i}}</annotation></semantics></math></span>
 where <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mi>u</mi></msub></mrow><annotation encoding="application/x-tex">n_{u}</annotation></semantics></math></span>
 is the number of users and <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">n_{i}</annotation></semantics></math></span>
 is the number of items.  Let <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">R_{i,j}</annotation></semantics></math></span>
 entry correspoing to the <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span>
-th row and <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span>
-th column of the matrix <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="bold">R</mtext></mrow><annotation encoding="application/x-tex">\textbf{R}</annotation></semantics></math></span>
. <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">R_{i,j}</annotation></semantics></math></span>
 is then the rating by user <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span>
 on item <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span>
.  The entries that have missing values in the matrix will be filled in with 0&rsquo;s.</p>
<p>In collaborative filtering we typically focus on two tasks. The first is,</p>
<p>**1.) Given a user and an item, what is the user’s likely preference for the item? **</p>
<p>This can also be viewed as filling in the missing values in the table above.  The second task is,</p>
<p>**2.) Recommend a list of <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span>
 items for a user based off of information we can obtain from the user-item table.  **</p>
<p>Within collaborative filtering there are two different modeling perspectives to answering the first question:</p>
<ul>
<li>
<p><strong>Memory based</strong>: This approach uses customer rating data to compute the similarity between customers or items and make recommendations. This was an early approach used in many commercial systems and has the benefit of being easy to explain. However, it doesnt scale well with sparse data as we will discuss later.</p>
</li>
<li>
<p><strong>Model based</strong>: This approach to collaborative filtering scales much better with sparse data and can uncover hidden or latent features in our dataset.  One draw back to this method is that it can be hard to explain/justitfy the predictions.</p>
</li>
</ul>
<p>In this blog post I&rsquo;ll talk I&rsquo;ll go user-user collaborative filtering to predict how a given user will rate an item for now and look into other methods later on. Let&rsquo;s jump into the code&hellip;</p>
<hr>
<h2 id="preprocessing--basic-statistics">
  Preprocessing &amp; Basic Statistics <a class="anchor" id="second-bullet"></a>
  <a class="heading-link" href="#preprocessing--basic-statistics">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<hr>
<p>First let&rsquo;s load some of the basic libraries,</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> scipy.sparse <span style="color:#f92672">import</span> csc_matrix
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> seaborn <span style="color:#66d9ef">as</span> sns
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span>matplotlib inline
</span></span></code></pre></div><p>The data we will use comes from <a href="https:amazon.com">Amazon</a> and can be found <a href="http://jmcauley.ucsd.edu/data/amazon/">here</a>.  I chose the Amazon Instant Video 5 core file. The 5 core implies that each video/item has atleast 5 ratings and each users has rated atleast 5 videos/items.  Unzipping the file results in a json file that I was not  able to read using the Pandas <a href="http://pandas.pydata.org/pandas-docs/stable/generated/pandas.read_json.html">read_json</a> function. So I read in the contents of the file using the function below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> readFunctions <span style="color:#f92672">import</span> openFile
</span></span><span style="display:flex;"><span>df <span style="color:#f92672">=</span> openFile(<span style="color:#e6db74">&#39;reviews_Amazon_Instant_Video_5.json.gz&#39;</span>)
</span></span></code></pre></div><p>We can get the basic info on the dataset, including the number of reviews and the column descriptions using the Pandas <a href="http://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.info.html">info</a> function,</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>df<span style="color:#f92672">.</span>info()
</span></span></code></pre></div><pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 37126 entries, 0 to 37125
Data columns (total 10 columns):
Unnamed: 0        37126 non-null int64
reviewerID        37126 non-null object
asin              37126 non-null object
reviewerName      36797 non-null object
helpful           37126 non-null object
unixReviewTime    37126 non-null int64
reviewText        37126 non-null object
overall           37126 non-null float64
reviewTime        37126 non-null object
summary           37126 non-null object
dtypes: float64(1), int64(2), object(7)
memory usage: 2.8+ MB
</code></pre>
<p>We can also get a peek at the data by looking at the first few rows,</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>df<span style="color:#f92672">.</span>head(<span style="color:#ae81ff">2</span>)
</span></span></code></pre></div><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Unnamed: 0</th>
      <th>reviewerID</th>
      <th>asin</th>
      <th>reviewerName</th>
      <th>helpful</th>
      <th>unixReviewTime</th>
      <th>reviewText</th>
      <th>overall</th>
      <th>reviewTime</th>
      <th>summary</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>A11N155CW1UV02</td>
      <td>B000H00VBQ</td>
      <td>AdrianaM</td>
      <td>[0, 0]</td>
      <td>1399075200</td>
      <td>I had big expectations because I love English ...</td>
      <td>2.0</td>
      <td>05 3, 2014</td>
      <td>A little bit boring for me</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>A3BC8O2KCL29V2</td>
      <td>B000H00VBQ</td>
      <td>Carol T</td>
      <td>[0, 0]</td>
      <td>1346630400</td>
      <td>I highly recommend this series. It is a must f...</td>
      <td>5.0</td>
      <td>09 3, 2012</td>
      <td>Excellent Grown Up TV</td>
    </tr>
  </tbody>
</table>
</div>
<p>The <code>asin</code> value for each review is the actual &ldquo;id&rdquo; of the product or video on Amazon. If you copy and paste this id/code into the search on <a href="https://amazon.com">amazon.com</a>, then the product list will come up!</p>
<p>Now, let&rsquo;s start out by get some basic statistics on the ratings of Amazon instant videos in the data,</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Mean rating : </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(df[<span style="color:#e6db74">&#39;overall&#39;</span>]<span style="color:#f92672">.</span>mean()))
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Mean rating standard deviation: </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(df[<span style="color:#e6db74">&#39;overall&#39;</span>]<span style="color:#f92672">.</span>std()))
</span></span></code></pre></div><pre><code>Mean rating : 4.209529709637451
Mean rating standard deviation: 1.1185496668776922
</code></pre>
<p>The average rating over all videos is 4.2 out of 5.  We can see the overall distribution of reviews below,</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>fig <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">4</span>))
</span></span><span style="display:flex;"><span>ax  <span style="color:#f92672">=</span> fig<span style="color:#f92672">.</span>add_subplot(<span style="color:#ae81ff">111</span>)
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>hist(df[<span style="color:#e6db74">&#39;overall&#39;</span>], bins<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0.9</span>, <span style="color:#ae81ff">1.1</span>, <span style="color:#ae81ff">1.9</span>, <span style="color:#ae81ff">2.1</span>, <span style="color:#ae81ff">2.9</span>, <span style="color:#ae81ff">3.1</span>, <span style="color:#ae81ff">3.9</span>, <span style="color:#ae81ff">4.1</span>, <span style="color:#ae81ff">4.9</span>, <span style="color:#ae81ff">5.1</span>])
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>set_xlabel(<span style="color:#e6db74">&#39;Overall review&#39;</span>, fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">13</span>)
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>set_ylabel(<span style="color:#e6db74">&#39;count of reviews&#39;</span>, fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">13</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ax.title(&#39;Distribution of reviews&#39;, fontsize=15)</span>
</span></span></code></pre></div><pre><code>Text(0, 0.5, 'count of reviews')
</code></pre>
<p><img src="/recommender_files/recommender_11_1.png" alt="png"></p>
<p>We can also get the number of reviewers by counting the unique values of <code>reviewerID</code> and the product by counting the unique values of <code>asin</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>num_users <span style="color:#f92672">=</span> len(df[<span style="color:#e6db74">&#39;reviewerID&#39;</span>]<span style="color:#f92672">.</span>unique())
</span></span><span style="display:flex;"><span>num_items <span style="color:#f92672">=</span> len(df[<span style="color:#e6db74">&#39;asin&#39;</span>]<span style="color:#f92672">.</span>unique())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Number of reviewers: </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(num_users))
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Number of products : </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(num_items))
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Number of ratings  : </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(len(df)))
</span></span></code></pre></div><pre><code>Number of reviewers: 5130
Number of products : 1685
Number of ratings  : 37126
</code></pre>
<p>We can also find out the average number of ratings per reviewer using the  <a href="http://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.groupby.html">groupby</a> function with <code>reviewerID</code> and then counting the number of product reviews,</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>avg_num_reviews <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;reviewerID&#39;</span>)[<span style="color:#e6db74">&#39;asin&#39;</span>]<span style="color:#f92672">.</span>count()
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Avg Number of ratings per reviewer </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(avg_num_reviews<span style="color:#f92672">.</span>mean()))
</span></span></code></pre></div><pre><code>Avg Number of ratings per reviewer 7.237037037037037
</code></pre>
<p>We can also get the distribution of the mean rating of each reviewer,</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>mean_rating_of_user <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;reviewerID&#39;</span>)<span style="color:#f92672">.</span>apply(<span style="color:#66d9ef">lambda</span> x: x[<span style="color:#e6db74">&#39;overall&#39;</span>]<span style="color:#f92672">.</span>mean())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fig <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">4</span>))
</span></span><span style="display:flex;"><span>ax  <span style="color:#f92672">=</span> fig<span style="color:#f92672">.</span>add_subplot(<span style="color:#ae81ff">111</span>)
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>hist(mean_rating_of_user)
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>set_xlabel(<span style="color:#e6db74">&#39;mean rating given by each reviewer&#39;</span>, fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">13</span>)
</span></span><span style="display:flex;"><span>ax<span style="color:#f92672">.</span>set_ylabel(<span style="color:#e6db74">&#39;number of reviewers&#39;</span>, fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">13</span>)
</span></span></code></pre></div><pre><code>Text(0, 0.5, 'number of reviewers')
</code></pre>
<p><img src="/recommender_files/recommender_17_1.png" alt="png"></p>
<p>We could keep exploring the data to get more insights, but one of the appealing aspects about collaborative filtering is that we don&rsquo;t actually have to know much about the products or customters&rsquo; preferences in order to make recommedations. Instead, all we need to need is the user-item table or ratings matrix and this is what we will discuss next.</p>
<p>Now we want to make a ratings matrix out of our DataFrame to represent the user-item table.  In order to do this we have to assign each video and reviewer an unique index that will correspond to a row and a column in the matrix respectively. We do this by turning each <a href="http://pandas.pydata.org/pandas-docs/stable/categorical.html">categorical</a> data-types:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># turn each reviewer and product into categorical data,</span>
</span></span><span style="display:flex;"><span>df[<span style="color:#e6db74">&#39;reviewerID&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;reviewerID&#39;</span>]<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#34;category&#34;</span>)
</span></span><span style="display:flex;"><span>df[<span style="color:#e6db74">&#39;asin&#39;</span>]       <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;asin&#39;</span>]<span style="color:#f92672">.</span>astype(<span style="color:#e6db74">&#34;category&#34;</span>)
</span></span></code></pre></div><p>We then create a matrix of all the videos/reviewer/ratings tripples for the training set.  We format the matrix such that each row is a unique item/video and each column is a unique reviewer.  The value of each matrix <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">R_{i,j}</annotation></semantics></math></span>
 will then be the rating that a reviewer <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span>
 gave on video <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span>
:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>reviews <span style="color:#f92672">=</span> csc_matrix((df[<span style="color:#e6db74">&#39;overall&#39;</span>]<span style="color:#f92672">.</span>astype(float), 
</span></span><span style="display:flex;"><span>                     (df[<span style="color:#e6db74">&#39;reviewerID&#39;</span>]<span style="color:#f92672">.</span>cat<span style="color:#f92672">.</span>codes,
</span></span><span style="display:flex;"><span>                      df[<span style="color:#e6db74">&#39;asin&#39;</span>]<span style="color:#f92672">.</span>cat<span style="color:#f92672">.</span>codes)))
</span></span><span style="display:flex;"><span>reviews<span style="color:#f92672">.</span>shape
</span></span></code></pre></div><pre><code>(5130, 1685)
</code></pre>
<p>Since most reviewers/customers only rate a few videos there will be many entries in this matrix with missing values and by default will have 0 value.  Since there will be so few non-zero values this matrix will be pretty sparse and hence we should use a sparse matrix to store it. A sparse matrix only stores the non-zero entries and reduces memory usage.  However, our data is not that large and dense matrices can be a little easier to work with so I will convert this matrix into a dense one:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ratings_matrix <span style="color:#f92672">=</span> reviews<span style="color:#f92672">.</span>toarray()
</span></span></code></pre></div><p>We can see then sparsity of this matrix,</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sparsity <span style="color:#f92672">=</span> float(len(ratings_matrix<span style="color:#f92672">.</span>nonzero()[<span style="color:#ae81ff">0</span>]))
</span></span><span style="display:flex;"><span>sparsity <span style="color:#f92672">/=</span> (ratings_matrix<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> ratings_matrix<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>sparsity <span style="color:#f92672">*=</span> <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Sparsity: </span><span style="color:#e6db74">{:4.2f}</span><span style="color:#e6db74">%&#34;</span><span style="color:#f92672">.</span>format(sparsity))
</span></span></code></pre></div><pre><code>Sparsity: 0.43%
</code></pre>
<p>The main idea of collaborative filtering is we want to predict how each user will feel about a product, that is, to find the missing values in the matrix. One idea is to fill in the missing values with the mean rating of all users and on all products. The overall mean can be obtained by,</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>mean_rating <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;overall&#39;</span>]<span style="color:#f92672">.</span>mean()
</span></span></code></pre></div><p>We can get then root mean square error in this prediction by computing by getting the non-zero rating values in the matrices using the above method and taking the square of the difference in these values from the <code>mean_rating</code>,</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>base_rmse <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>sqrt(pow(df[<span style="color:#e6db74">&#39;overall&#39;</span>]<span style="color:#f92672">-</span>mean_rating, <span style="color:#ae81ff">2</span>)<span style="color:#f92672">.</span>mean())
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;RMSE = </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(base_rmse))
</span></span></code></pre></div><pre><code>RMSE = 1.1185346025400433
</code></pre>
<p>This is a pretty naive approach, but it will give us a baseline to compare the other methods we use.  Our goal will be to find collaborative filtering methods that result in smaller errors than above and we will start with user-user collaborative filtering.</p>
<hr>
<h2 id="user-user-collaborative-filtering">
  User-User Collaborative Filtering <a class="anchor" id="third-bullet"></a>
  <a class="heading-link" href="#user-user-collaborative-filtering">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<hr>
<p>The basic idea of user-user collaborative filtering is to predict a customer, <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span>
&rsquo;s rating of a product, <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span>
, by finding customers that are similar to <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span>
 and use their rating of product <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span>
 to estimate how customer <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span>
 would rate it.  The way we measure how similar customers are is through a function called the <a href="https://en.wikipedia.org/wiki/Cosine_similarity">cosine similarity</a> function.  The cosine similarity between user <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span>
 and user <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span>
 is the normalized dot product of their row vectors, (<span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext mathvariant="bold">r</mtext><mi>u</mi></msub></mrow><annotation encoding="application/x-tex">\textbf{r}_{u}</annotation></semantics></math></span>
 and <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext mathvariant="bold">r</mtext><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\textbf{r}_{v}</annotation></semantics></math></span>
 respectively) in the rating matrix <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="bold">R</mtext></mrow><annotation encoding="application/x-tex">\textbf{R}</annotation></semantics></math></span>
,</p>

<span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>s</mi><mo stretchy="false">(</mo><mi>u</mi><mo separator="true">,</mo><mi>v</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><msub><mtext mathvariant="bold">r</mtext><mi>u</mi></msub><mo>⋅</mo><msub><mtext mathvariant="bold">r</mtext><mi>v</mi></msub></mrow><mrow><mi mathvariant="normal">∥</mi><msub><mtext mathvariant="bold">r</mtext><mi>u</mi></msub><mi mathvariant="normal">∥</mi><mi mathvariant="normal">∥</mi><msub><mtext mathvariant="bold">r</mtext><mi>v</mi></msub><mi mathvariant="normal">∥</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex"> s(u,v) = \frac{\textbf{r}_{u} \cdot \textbf{r}_{v}}{ \Vert \textbf{r}_{u} \Vert \Vert \textbf{r}_{v} \Vert} </annotation></semantics></math></span>
<p>As mentioned previously, unknown ratings are considered to be 0; this causes them to effectively drop out of the numerator. To generate predictions for user <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span>
 on product <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span>
 from the cosine similarity function we then use a weighted average of some set of similar users (<span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span>
) and thoses customers ratings of product <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span>
,</p>

<span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>p</mi><mrow><mi>u</mi><mo separator="true">,</mo><mi>i</mi></mrow></msub><mo>=</mo><msub><mover accent="true"><mi>r</mi><mo>ˉ</mo></mover><mi>u</mi></msub><mo>+</mo><mfrac><mrow><munder><mo>∑</mo><mrow><mi>v</mi><mo>∈</mo><mi>N</mi></mrow></munder><mi>s</mi><mo stretchy="false">(</mo><mi>u</mi><mo separator="true">,</mo><mi>v</mi><mo stretchy="false">)</mo><mo stretchy="false">(</mo><msub><mi>R</mi><mrow><mi>v</mi><mo separator="true">,</mo><mi>i</mi></mrow></msub><mo>−</mo><msub><mover accent="true"><mi>r</mi><mo>ˉ</mo></mover><mi>v</mi></msub><mo stretchy="false">)</mo></mrow><mrow><munder><mo>∑</mo><mrow><mi>v</mi><mo>∈</mo><mi>N</mi></mrow></munder><mi mathvariant="normal">∣</mi><mi>s</mi><mo stretchy="false">(</mo><mi>u</mi><mo separator="true">,</mo><mi>v</mi><mo stretchy="false">)</mo><mi mathvariant="normal">∣</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex"> p_{u,i} = \bar{r}_{u} + \frac{\sum_{v \in N} s(u,v) (R_{v,i} - \bar{r}_{v})}{\sum_{v \in N} \vert s(u,v) \vert} </annotation></semantics></math></span>
<p><span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>r</mi><mo>ˉ</mo></mover><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\bar{r}_{v}</annotation></semantics></math></span>
 is the mean rating of all customers on all products and  <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>r</mi><mo>ˉ</mo></mover><mi>u</mi></msub></mrow><annotation encoding="application/x-tex">\bar{r}_{u}</annotation></semantics></math></span>
 is the mean rating of user <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi></mrow><annotation encoding="application/x-tex">u</annotation></semantics></math></span>
 on all products.</p>
<p>In order to compute the cosine similarity function between users we import the <a href="http://scikit-learn.org/stable/modules/generated/sklearn.metrics.pairwise.cosine_similarity.html">cosine_similarity</a> function from the <a href="http://scikit-learn.org/stable/">scikit-learn</a> library:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> sklearn.metrics.pairwise <span style="color:#f92672">import</span> cosine_similarity
</span></span></code></pre></div><p>We end up pre-computing all the cosine similarities between users and make a similarity matrix out it in the function calls below.  The first user-user collaborative filtering algorithm is below. We first compare each users similarity to <em>all</em> other users and make recommendations.  Notice we dont break up our data into training and testing sets.  Instead, we loop over all the users and all the products and treat each product for each user as a missing value and then predict its value. We then get the error between the predicted rating and the actual rating.</p>
<p>The function below will then return the root mean square error in this algorithm over all users.</p>
<p>** NOTE: This method is not meant for speed, it is not ideal for caching and memory usage.**</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">User_User_CF</span>(reviews):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Obtains the RMSE error in the user-user collaborative 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    filtering algorithms using all the similar users.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :param: reviews (numpy.ndarray) : The dense user-item matrix.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :returns: RMSE of predictions
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :rvalue: float
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Get the user-user similarity matrix</span>
</span></span><span style="display:flex;"><span>    user_user_similarity <span style="color:#f92672">=</span> cosine_similarity(reviews)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    sqdiffs <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    num_preds <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># to protect against divide by zero issues</span>
</span></span><span style="display:flex;"><span>    eps <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e-6</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    cnt_no_sims <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># loop over the users</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> user_i, u <span style="color:#f92672">in</span> enumerate(reviews):
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># products user HAS rated</span>
</span></span><span style="display:flex;"><span>        i_rated <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>where(u<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Get the average rating for this user</span>
</span></span><span style="display:flex;"><span>        user_avg <span style="color:#f92672">=</span>  i_rated<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># loop over all the products that each user reviewed</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Note: these are all the non-zero entries in the row</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i_product <span style="color:#f92672">in</span> i_rated:
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Get all the users (indices) that</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># have also reviewed this product.</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Note: This also includes the user of interest!</span>
</span></span><span style="display:flex;"><span>            i_has_rated <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>where(reviews[:, i_product])[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># remove the user (indices) of interest </span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># from this column</span>
</span></span><span style="display:flex;"><span>            i_remove <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>argmin(abs(i_has_rated <span style="color:#f92672">-</span> user_i))
</span></span><span style="display:flex;"><span>            i_others_have_rated <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>delete(i_has_rated, i_remove)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Get the ratings for product by the similar users,</span>
</span></span><span style="display:flex;"><span>            ratings <span style="color:#f92672">=</span> reviews[i_others_have_rated, 
</span></span><span style="display:flex;"><span>                              i_product]
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>            ratings <span style="color:#f92672">-=</span> user_avg
</span></span><span style="display:flex;"><span>               
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># get the cosine similarity between the users</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># and other users.</span>
</span></span><span style="display:flex;"><span>            similarities <span style="color:#f92672">=</span> user_user_similarity[user_i,
</span></span><span style="display:flex;"><span>                                                i_others_have_rated]
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># denominator of user_i&#39;s produdct prediction</span>
</span></span><span style="display:flex;"><span>            norm <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>sum(similarities)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> norm<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>                cnt_no_sims <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                norm <span style="color:#f92672">=</span> eps
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># prediction of user u on product i: p_{u,i}</span>
</span></span><span style="display:flex;"><span>            predicted_rating <span style="color:#f92672">=</span> user_avg <span style="color:#f92672">+</span> np<span style="color:#f92672">.</span>sum(np<span style="color:#f92672">.</span>multiply(
</span></span><span style="display:flex;"><span>                                            ratings<span style="color:#f92672">.</span>T,
</span></span><span style="display:flex;"><span>                                            similarities))<span style="color:#f92672">/</span>norm
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># actual rating by user u on product i</span>
</span></span><span style="display:flex;"><span>            actual_rating <span style="color:#f92672">=</span> reviews[user_i, i_product]
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># get the L2 difference in predicted and actual</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># rating for the user</span>
</span></span><span style="display:flex;"><span>        sqdiffs <span style="color:#f92672">+=</span> pow(predicted_rating <span style="color:#f92672">-</span> actual_rating, <span style="color:#ae81ff">2.0</span>)
</span></span><span style="display:flex;"><span>        num_preds<span style="color:#f92672">+=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># get the average of all the predictions</span>
</span></span><span style="display:flex;"><span>    rmse_cossim <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>sqrt(sqdiffs<span style="color:#f92672">/</span>num_preds)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> rmse_cossim
</span></span></code></pre></div><p>Let&rsquo;s see how well the algorithm performs by computing the RMSE of the predicted user ratings,</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>user_all_rmse <span style="color:#f92672">=</span> User_User_CF(ratings_matrix)
</span></span><span style="display:flex;"><span>print(user_all_rmse)
</span></span></code></pre></div><pre><code>1.0389437862440354
</code></pre>
<p>This is definitely an improvement in the prediction error compared to just using the mean ratings as an approximate for unknown customer ratings!</p>
<p>We might be able to improve the runtime of our algorithm if we reduce the number of customers we use to generate recommendations.  If a customer is disimilar to our customer of interest, not including them in our computations may not effect the accuracy of prediction, but reduce the number of computations we have to do. The next function performs user-user collaborative filtering just as above, but this time only uses the top <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span>
 most similar customers to predict the customer of interest&rsquo;s missing rating:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">User_User_CF_TopN</span>(reviews, N):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Obtains the RMSE error in the user-user collaborative 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    filtering algorithms using the top N most similar users.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :param: reviews (numpy.ndarray) : The dense user-item matrix.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :param: N (int) : The number of the most similar users.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :returns: RMSE of predictions
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :rvalue: float
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Get the user-user similarity matrix</span>
</span></span><span style="display:flex;"><span>    user_user_similarity <span style="color:#f92672">=</span> cosine_similarity(reviews)
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    sqdiffs <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    num_preds <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># to protect against divide by zero issues</span>
</span></span><span style="display:flex;"><span>    eps <span style="color:#f92672">=</span> <span style="color:#ae81ff">1e-6</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    cnt_no_sims <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># loop over the users</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> user_i, u <span style="color:#f92672">in</span> enumerate(reviews):
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># products user HAS rated</span>
</span></span><span style="display:flex;"><span>        i_rated <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>where(u<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Get the average rating for this user</span>
</span></span><span style="display:flex;"><span>        user_avg <span style="color:#f92672">=</span> i_rated<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># loop over all the products that each user reviewed</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Note: these are all the non-zero entries in the row</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i_product <span style="color:#f92672">in</span> i_rated:
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Get all the users (indices) that</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># have also reviewed this product.</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Note: This also includes the user of interest!</span>
</span></span><span style="display:flex;"><span>            i_has_rated <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>where(reviews[:, i_product]<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># remove the user (indices) of interest </span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># from this column</span>
</span></span><span style="display:flex;"><span>            i_remove <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>argmin(abs(i_has_rated <span style="color:#f92672">-</span> user_i))
</span></span><span style="display:flex;"><span>            i_others_have_rated <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>delete(i_has_rated, i_remove)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Get the ratings for product by the similar users,</span>
</span></span><span style="display:flex;"><span>            ratings <span style="color:#f92672">=</span> reviews[i_others_have_rated, 
</span></span><span style="display:flex;"><span>                              i_product]
</span></span><span style="display:flex;"><span>                    
</span></span><span style="display:flex;"><span>            ratings <span style="color:#f92672">-=</span> user_avg
</span></span><span style="display:flex;"><span>               
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># get the cosine similarity between the users</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># and other users.</span>
</span></span><span style="display:flex;"><span>            sims <span style="color:#f92672">=</span> user_user_similarity[user_i,
</span></span><span style="display:flex;"><span>                                        i_others_have_rated]
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">#choose top N most similar users</span>
</span></span><span style="display:flex;"><span>            most_similar_users <span style="color:#f92672">=</span> sims[np<span style="color:#f92672">.</span>argsort(sims<span style="color:#f92672">*-</span><span style="color:#ae81ff">1</span>)][:N]
</span></span><span style="display:flex;"><span>            most_similar_ratings <span style="color:#f92672">=</span> ratings[np<span style="color:#f92672">.</span>argsort(sims<span style="color:#f92672">*-</span><span style="color:#ae81ff">1</span>)][:N]
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># denominator of user_i&#39;s produdct prediction</span>
</span></span><span style="display:flex;"><span>            norm <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>sum(most_similar_users)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> norm<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>                cnt_no_sims <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>                norm <span style="color:#f92672">=</span> eps
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># prediction of user u on product i: p_{u,i}</span>
</span></span><span style="display:flex;"><span>            predicted_rating <span style="color:#f92672">=</span> user_avg <span style="color:#f92672">+</span> np<span style="color:#f92672">.</span>sum(np<span style="color:#f92672">.</span>multiply(
</span></span><span style="display:flex;"><span>                                            most_similar_ratings<span style="color:#f92672">.</span>T,
</span></span><span style="display:flex;"><span>                                            most_similar_users))<span style="color:#f92672">/</span>norm
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># actual rating by user u on product i</span>
</span></span><span style="display:flex;"><span>            actual_rating <span style="color:#f92672">=</span> reviews[user_i, i_product]
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># get the L2 difference in predicted and actual</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># rating for the user</span>
</span></span><span style="display:flex;"><span>        sqdiffs <span style="color:#f92672">+=</span> pow(predicted_rating <span style="color:#f92672">-</span> actual_rating, <span style="color:#ae81ff">2.0</span>)
</span></span><span style="display:flex;"><span>        num_preds<span style="color:#f92672">+=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># get the average of all the predictions</span>
</span></span><span style="display:flex;"><span>    rmse_cossim <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>sqrt(sqdiffs<span style="color:#f92672">/</span>num_preds)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> rmse_cossim
</span></span></code></pre></div><p>We can loop through a number different choices for <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span>
 (the number of most similar customters) and see how this number affects the error in our user-user collabortive filtering algorithm:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>N_users <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">25</span>,<span style="color:#ae81ff">50</span>]
</span></span><span style="display:flex;"><span>top_N   <span style="color:#f92672">=</span> [User_User_CF_TopN(ratings_matrix, i) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> N_users]
</span></span></code></pre></div><p>We can now compare the RMSE in the different recommendation methods:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># make constant vectors</span>
</span></span><span style="display:flex;"><span>user_all <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>mean_all <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(N_users)):
</span></span><span style="display:flex;"><span>    user_all<span style="color:#f92672">.</span>append(user_all_rmse)
</span></span><span style="display:flex;"><span>    mean_all<span style="color:#f92672">.</span>append(base_rmse)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">8</span>,<span style="color:#ae81ff">5</span>))
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot(N_users, top_N,    <span style="color:#e6db74">&#39;b&#39;</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;User-User CF, Top N Users&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot(N_users, user_all, <span style="color:#e6db74">&#39;r&#39;</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;User-User CF, All Users&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot(N_users, mean_all, <span style="color:#e6db74">&#39;k&#39;</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Mean Rating Of All Users&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;N&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;RMSE Error&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>legend()
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;RMSE Error In Recommender Predictions&#39;</span>)
</span></span></code></pre></div><pre><code>Text(0.5, 1.0, 'RMSE Error In Recommender Predictions')
</code></pre>
<p><img src="/recommender_files/recommender_43_1.png" alt="png"></p>
<p>We can see that after aboud 25 users there isn&rsquo;t much improvement in predictive power of collaborative filtering.</p>
<hr>
<h2 id="next-steps">
  Next Steps&hellip; <a class="anchor" id="fourth-bullet"></a>
  <a class="heading-link" href="#next-steps">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<hr>
<p>User-User collaborative filtering while definitely an improvement over using the mean rating as predictor has some serious limitations.  First of all it does not scale well as the number of users grows. This is because searching for similar users will take longer as the list of users grows. Another method which scales better with a larger user base is item-item collaborative filtering, which is incredibly similar to user-user collaborative filtering.  An even better method is to use matrix-factorization in model based collaborative filtering. I&rsquo;ll be updating this post soon and go into the details of using another method.</p>

      </div>


      <footer>
        

<section class="see-also">
  
    
    
    
  
</section>


        
        
        
        
        
        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
      2016 -
    
    2025
     Mike Harmon 
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.js"></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>
</html>
