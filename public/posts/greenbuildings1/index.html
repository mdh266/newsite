<!DOCTYPE html>
<html lang="en">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <title>
  Green Buildings 1: Exploratory Analysis &amp; Outlier Removal · Mike Harmon
</title>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Mike Harmon">
<meta name="description" content="
  
  
    
    Link to heading
  


  Content
  
    
    Link to heading
  


1. Introduction
2. Exploratory Data Analysis
3. Connecting To BigQuery
4. Removing Visual Outliers
5. Removing Outliers With Isolation Forests
6. Recomendations &amp; Next Steps

  Introduction 
  
    
    Link to heading
  


I started this project a while back with a goal of taking the 2016 NYC Benchmarking Law building energy usage data and do something interesting with it. I originally attmpted to clean and analyze this data set to try to find ways to reduce builings&rsquo; energy usage and subsequently their green house gas emissions. After a few iterations I thought it might be interesting to see if I could predict the emission of green house gases from buildings by looking at their age, energy and water consumption as well as other energy consumption metrics. This is somewhat of a difficult task as the data was very messy and in this first blogpost I will cover how to perform,">
<meta name="keywords" content="blog,data,ai">



  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Green Buildings 1: Exploratory Analysis & Outlier Removal">
  <meta name="twitter:description" content="Link to heading Content Link to heading 1. Introduction
2. Exploratory Data Analysis
3. Connecting To BigQuery
4. Removing Visual Outliers
5. Removing Outliers With Isolation Forests
6. Recomendations &amp; Next Steps
Introduction Link to heading I started this project a while back with a goal of taking the 2016 NYC Benchmarking Law building energy usage data and do something interesting with it. I originally attmpted to clean and analyze this data set to try to find ways to reduce builings’ energy usage and subsequently their green house gas emissions. After a few iterations I thought it might be interesting to see if I could predict the emission of green house gases from buildings by looking at their age, energy and water consumption as well as other energy consumption metrics. This is somewhat of a difficult task as the data was very messy and in this first blogpost I will cover how to perform,">

<meta property="og:url" content="http://localhost:1313/posts/greenbuildings1/">
  <meta property="og:site_name" content="Mike Harmon">
  <meta property="og:title" content="Green Buildings 1: Exploratory Analysis & Outlier Removal">
  <meta property="og:description" content="Link to heading Content Link to heading 1. Introduction
2. Exploratory Data Analysis
3. Connecting To BigQuery
4. Removing Visual Outliers
5. Removing Outliers With Isolation Forests
6. Recomendations &amp; Next Steps
Introduction Link to heading I started this project a while back with a goal of taking the 2016 NYC Benchmarking Law building energy usage data and do something interesting with it. I originally attmpted to clean and analyze this data set to try to find ways to reduce builings’ energy usage and subsequently their green house gas emissions. After a few iterations I thought it might be interesting to see if I could predict the emission of green house gases from buildings by looking at their age, energy and water consumption as well as other energy consumption metrics. This is somewhat of a difficult task as the data was very messy and in this first blogpost I will cover how to perform,">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2018-05-12T00:00:00+00:00">
    <meta property="article:modified_time" content="2018-05-12T00:00:00+00:00">
    <meta property="article:tag" content="Scikit-Learn">
    <meta property="article:tag" content="K-Nearest Neighbors">
    <meta property="article:tag" content="Big Query">
    <meta property="article:tag" content="Missing Value Imputation">
    <meta property="article:tag" content="Google Cloud">
      <meta property="og:see_also" content="http://localhost:1313/posts/kmeans/">
      <meta property="og:see_also" content="http://localhost:1313/posts/greenbuildings3/">
      <meta property="og:see_also" content="http://localhost:1313/posts/greenbuildings2/">




<link rel="canonical" href="http://localhost:1313/posts/greenbuildings1/">


<link rel="preload" href="/fonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="/fonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.css" media="screen">






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.css" media="screen">
  



 


  
  
    
    
    <link rel="stylesheet" href="/scss/coder.css" media="screen">
  

  
  
    
    
    <link rel="stylesheet" href="/scss/coder-dark.css" media="screen">
  



<link rel="icon" type="image/svg+xml" href="/images/favicon.svg" sizes="any">
<link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">









</head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    
    <a class="navigation-title" href="http://localhost:1313/">
      Mike Harmon
    </a>
    
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa-solid fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link " href="/about">About</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/posts/">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/projects/">Projects</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link " href="/contact/">Contact me</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="http://localhost:1313/posts/greenbuildings1/">
              Green Buildings 1: Exploratory Analysis &amp; Outlier Removal
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa-solid fa-calendar" aria-hidden="true"></i>
              <time datetime="2018-05-12T00:00:00Z">
                May 12, 2018
              </time>
            </span>
            <span class="reading-time">
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              25-minute read
            </span>
          </div>
          <div class="authors">
  <i class="fa-solid fa-user" aria-hidden="true"></i>
    <a href="/authors/mike-harmon/">Mike Harmon</a></div>

          
          <div class="tags">
  <i class="fa-solid fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/tags/scikit-learn/">Scikit-Learn</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/tags/k-nearest-neighbors/">K-Nearest Neighbors</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/tags/big-query/">Big Query</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/tags/missing-value-imputation/">Missing Value Imputation</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/tags/google-cloud/">Google Cloud</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <h1 id="">
  
  <a class="heading-link" href="#">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<h2 id="content">
  Content
  <a class="heading-link" href="#content">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<hr>
<p><strong><a href="#first-bullet" >1. Introduction</a></strong></p>
<p><strong><a href="#second-bullet" >2. Exploratory Data Analysis</a></strong></p>
<p><strong><a href="#third-bullet" >3. Connecting To BigQuery</a></strong></p>
<p><strong><a href="#fourth-bullet" >4. Removing Visual Outliers</a></strong></p>
<p><strong><a href="#fifth-bullet" >5. Removing Outliers With Isolation Forests</a></strong></p>
<p><strong><a href="#sixth-bullet" >6. Recomendations &amp; Next Steps</a></strong></p>
<h2 id="introduction">
  Introduction <a class="anchor" id="first-bullet"></a>
  <a class="heading-link" href="#introduction">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<hr>
<p>I started this project a while back with a goal of taking the 2016 NYC Benchmarking Law building energy usage data and do something interesting with it. I originally attmpted to clean and analyze this data set to try to find ways to reduce builings&rsquo; energy usage and subsequently their green house gas emissions. After a few iterations I thought it might be interesting to see if I could predict the emission of green house gases from buildings by looking at their age, energy and water consumption as well as other energy consumption metrics. This is somewhat of a difficult task as the data was very messy and in this first blogpost I will cover how to perform,</p>
<ul>
<li>Exploratory data analysis</li>
<li>Identify and remove outliers</li>
</ul>
<p>Since I will completing this project over multiple days and using <a href="https://cloud.google.com/"  class="external-link" target="_blank" rel="noopener">Google Cloud</a>, I will go over the basics of using <a href="https://cloud.google.com/bigquery"  class="external-link" target="_blank" rel="noopener">BigQuery</a> for storing the datasets so I won&rsquo;t have to start all over again each time I work on it.  At the end of this blogpost I will summarize the findings, and give some specific recommendations to reduce mulitfamily and office building energy usage. The source code for this project can be found <a href="https://github.com/mdh266/NYCBuildingEnergyUse">here</a>.</p>
<hr>
<h3 id="data">
  Data
  <a class="heading-link" href="#data">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h3>
<hr>
<p>The NYC Benchmarking Law requires owners of large buildings to annually measure their energy and water consumption in a process called benchmarking. The law standardizes this process by requiring building owners to enter their annual energy and water use in the U.S. Environmental Protection Agency&rsquo;s (EPA) online tool, ENERGY STAR Portfolio Manager® and use the tool to submit data to the City. This data gives building owners information about a building&rsquo;s energy and water consumption compared to similar buildings, and tracks progress year over year to help in energy efficiency planning.</p>
<p>Benchmarking data is also disclosed publicly and can be found <a href="http://www.nyc.gov/html/gbee/html/plan/ll84_scores.shtml">here</a>.  I analyzed the 2016 data and my summary of the findings and recommendations for reducing energy consumption in New York City buildings are discussed in the conclusions post.</p>
<p>The data comes from the year 2016 and is quite messy and a lot of cleaning is necessary to do analysis on it. The cleaning process was made more difficult because the data was stored as strings with multiple non-numeric values which made converting the data to its proper type a more involved process.  One thing to keep in mind through out this post is that this is <strong>self-reported data</strong>, meaning our data is mostly biased, containinig outliers. Therefore, I will go over a few techniques for removing outliers in post.</p>
<h2 id="exploratory-data-analysis">
  Exploratory Data Analysis <a class="anchor" id="second-bullet"></a>
  <a class="heading-link" href="#exploratory-data-analysis">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<hr>
<p>Since the cleaning was more tedious I created external functions do handle this processes.  In addition, I also created functions to handle transforming and plotting the data.  I kept these functions in seperate files <code>Cleaning_Functions.py</code> and <code>Plotting_Functions.py</code> respecively so as to not clutter the post.  We import these functions along with other basic libraries (<a href="http://pandas.pydata.org/">Pandas</a>, <a href="http://matplotlib.org/">Matplotlib</a> and <a href="http://seaborn.pydata.org/">Seaborn</a>) as well as read in the data file below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> warnings
</span></span><span style="display:flex;"><span>warnings<span style="color:#f92672">.</span>filterwarnings(<span style="color:#e6db74">&#39;ignore&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> seaborn <span style="color:#66d9ef">as</span> sns
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span>matplotlib inline
</span></span><span style="display:flex;"><span>sns<span style="color:#f92672">.</span>set()
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> utilities.CleaningFunctions <span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    initial_clean, 
</span></span><span style="display:flex;"><span>    convert_GeoPandas_to_Bokeh_format,
</span></span><span style="display:flex;"><span>    group_property_types
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>                                
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> utilities.PlottingFunctions <span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    plot_years_built, 
</span></span><span style="display:flex;"><span>    make_interactive_choropleth_map
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>Here is we specifify a few datatypes as integers while reading in the Excel using the <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.read_excel.html"  class="external-link" target="_blank" rel="noopener">read_excel</a> function from Pandas</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>df_2016 <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_excel(<span style="color:#e6db74">&#34;../data/nyc_benchmarking_disclosure_data_reported_in_2016.xlsx&#34;</span>,
</span></span><span style="display:flex;"><span>                       converters<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;Street Number&#39;</span>:int, 
</span></span><span style="display:flex;"><span>                                   <span style="color:#e6db74">&#39;Zip Code&#39;</span>:int,
</span></span><span style="display:flex;"><span>                                   <span style="color:#e6db74">&#39;Year Build&#39;</span>:int,
</span></span><span style="display:flex;"><span>                                   <span style="color:#e6db74">&#39;ENERGY STAR Score&#39;</span>:int})
</span></span></code></pre></div><p>There are about 13,233 buildings with different types of energy usage, emissions and other information.  I&rsquo;ll drop a bunch of these features and only keep the following,</p>
<ul>
<li>Reported NYC Building Identification Numbers : [BINs]</li>
<li>NYC Borough, Block and Lot : [BBL]</li>
<li>Street Number : [Street_Number]</li>
<li>Street Name : [Street_Name]</li>
<li>Zip Code : [Zip_Code]</li>
<li>Borough : [Borough]</li>
<li>Year Built : [Year_Built]</li>
<li>DOF Benchmarking Status :[Benchmarking_Status]</li>
<li>Site EUI (kBtu/ft<span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mrow></mrow><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">^{2}</annotation></semantics></math></span>
) : [Site_Eui]</li>
<li>Natural Gas Use [N(kBtu) : [Nat_Gas]</li>
<li>Electricity Use (kBtu):  [Elec_Use]</li>
<li>Total GHG Emissions (Metric Tons CO2e) : [GHG]</li>
<li>ENERGY STAR Score : [Energy_Star]</li>
<li>Water Use (All Water Sources) (kgal) : [Water_Use]</li>
</ul>
<p>The terms in the square brackets are the column names used in the dataframe. In addition, we must do some basic feature engineering.  The reported data gives us the metrics (<code>NAT_Gas</code>, <code>Elec_Use</code>, <code>GHG</code>, <code>Water_Use</code>) in terms of total volume. Using these metrics in comparing buildings of different sizes is not a fair comparison.  In order to compare them fairly we must standardize these metrics by dividing by the square footage of the buildings giving us each metrics&rsquo; intensity. We therefore have the following features,</p>
<ul>
<li>Nautral Gas Use Intensity (kBtu/ft<span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mrow></mrow><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">^{2}</annotation></semantics></math></span>
) : [NGI]</li>
<li>Electricty Use Intensity (kBtu/ft<span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mrow></mrow><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">^{2}</annotation></semantics></math></span>
) : [EI]</li>
<li>Water Use Intensity (kga/ft<span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mrow></mrow><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">^2</annotation></semantics></math></span>
) : [WI]</li>
<li>Total GHG Emissions Intensity (Metric Tons CO2e / ft<span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mrow></mrow><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">^2</annotation></semantics></math></span>
) : [GHGI]</li>
<li>Occupancy Per Square Foot (People / ft<span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mrow></mrow><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">^2</annotation></semantics></math></span>
) : [OPSQFT]</li>
<li>Age (years)</li>
</ul>
<p>I wrote a basic function called <code>initial_clean()</code>. to clean the data create the additional features. We call it on our dataset and then get some basic statistics about the data:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>df_2016_2 <span style="color:#f92672">=</span> initial_clean(df_2016)
</span></span><span style="display:flex;"><span>temp_cols_to_drop <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;BBL&#39;</span>,<span style="color:#e6db74">&#39;Street_Number&#39;</span>,<span style="color:#e6db74">&#39;Zip_Code&#39;</span>,<span style="color:#e6db74">&#39;Occupancy&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>df_2016_2<span style="color:#f92672">.</span>drop(temp_cols_to_drop, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)\
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">.</span>describe()
</span></span></code></pre></div><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Energy_Star</th>
      <th>Site_EUI</th>
      <th>Nat_Gas</th>
      <th>Elec_Use</th>
      <th>GHG</th>
      <th>Water_Use</th>
      <th>NGI</th>
      <th>EI</th>
      <th>WI</th>
      <th>GHGI</th>
      <th>OPSFT</th>
      <th>Age</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>9535.000000</td>
      <td>11439.000000</td>
      <td>1.008700e+04</td>
      <td>1.142500e+04</td>
      <td>1.147800e+04</td>
      <td>7.265000e+03</td>
      <td>9870.000000</td>
      <td>11206.000000</td>
      <td>7261.000000</td>
      <td>11258.000000</td>
      <td>11311.000000</td>
      <td>11531.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>57.735711</td>
      <td>525.733377</td>
      <td>2.520461e+07</td>
      <td>8.201496e+06</td>
      <td>6.952577e+03</td>
      <td>2.579751e+04</td>
      <td>137.705639</td>
      <td>54.266179</td>
      <td>0.161268</td>
      <td>0.031272</td>
      <td>0.001065</td>
      <td>67.857168</td>
    </tr>
    <tr>
      <th>std</th>
      <td>30.143817</td>
      <td>10120.105154</td>
      <td>1.194068e+09</td>
      <td>1.214643e+08</td>
      <td>1.692231e+05</td>
      <td>5.860239e+05</td>
      <td>7512.527146</td>
      <td>1210.530111</td>
      <td>2.053453</td>
      <td>0.571378</td>
      <td>0.000536</td>
      <td>30.263637</td>
    </tr>
    <tr>
      <th>min</th>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>-2.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>34.000000</td>
      <td>65.300000</td>
      <td>8.915501e+05</td>
      <td>1.045702e+06</td>
      <td>3.420250e+02</td>
      <td>2.661700e+03</td>
      <td>7.324853</td>
      <td>13.682696</td>
      <td>0.028523</td>
      <td>0.004308</td>
      <td>0.000629</td>
      <td>50.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>63.000000</td>
      <td>82.400000</td>
      <td>4.067600e+06</td>
      <td>1.885996e+06</td>
      <td>5.198000e+02</td>
      <td>4.745600e+03</td>
      <td>46.268145</td>
      <td>18.482229</td>
      <td>0.046098</td>
      <td>0.005455</td>
      <td>0.001075</td>
      <td>76.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>83.000000</td>
      <td>103.000000</td>
      <td>6.919267e+06</td>
      <td>4.513704e+06</td>
      <td>9.394500e+02</td>
      <td>8.057900e+03</td>
      <td>68.036285</td>
      <td>30.716894</td>
      <td>0.073287</td>
      <td>0.007003</td>
      <td>0.001525</td>
      <td>90.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>100.000000</td>
      <td>801504.700000</td>
      <td>1.101676e+11</td>
      <td>1.047620e+10</td>
      <td>1.501468e+07</td>
      <td>4.385740e+07</td>
      <td>737791.764249</td>
      <td>84461.681703</td>
      <td>98.340480</td>
      <td>39.190314</td>
      <td>0.001999</td>
      <td>417.000000</td>
    </tr>
  </tbody>
</table>
</div>
<p>The above table is only a summary of the numrical data in the dataframe. Just looking at the <code>count</code> column we can immediately see that there are a lot of missing valus in this data. This tells me that this data will be rather messy with many columns having NaNs or missing values.</p>
<p><em>It also looks like there is a lot of variation within this dataset.  Just looking at the <code>Site_EUI</code> statistic, the 75th percentile is is 103 (kBtu/ft²), but the max is 801,504.7 (kBtu/ft²).  This probably due to the number of different types of buildings in the city, as well as the fact that contains outliers.</em></p>
<p>The next thing I would like to see is how many of the buildings in NYC are passing the Benchmarking Submission Status:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">4</span>))
</span></span><span style="display:flex;"><span>df_2016_2[<span style="color:#e6db74">&#39;Benchmarking_Status&#39;</span>]<span style="color:#f92672">.</span>value_counts()\
</span></span><span style="display:flex;"><span>                                <span style="color:#f92672">.</span>plot(kind<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bar&#39;</span>,
</span></span><span style="display:flex;"><span>                                      fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>,
</span></span><span style="display:flex;"><span>                                      rot<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;DOF Benchmarking Submission Status&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">14</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;count&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>)
</span></span></code></pre></div><pre><code>Text(0, 0.5, 'count')
</code></pre>
<p><img src="/greenbuildings1_files/greenbuildings1_8_1.png" alt="png"></p>
<p>Most buildings are in compliance with the Department of Finance Benchmarking standards. Let&rsquo;s take a look at the violators:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>Violators <span style="color:#f92672">=</span> df_2016_2<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#34;Benchmarking_Status == &#39;In Violation&#39; &#34;</span>)
</span></span><span style="display:flex;"><span>Violators<span style="color:#f92672">.</span>head()
</span></span></code></pre></div><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>BBL</th>
      <th>BINs</th>
      <th>Street_Number</th>
      <th>Street_Name</th>
      <th>Zip_Code</th>
      <th>Borough</th>
      <th>Benchmarking_Status</th>
      <th>Property_Type</th>
      <th>Year_Built</th>
      <th>Occupancy</th>
      <th>...</th>
      <th>Nat_Gas</th>
      <th>Elec_Use</th>
      <th>GHG</th>
      <th>Water_Use</th>
      <th>NGI</th>
      <th>EI</th>
      <th>WI</th>
      <th>GHGI</th>
      <th>OPSFT</th>
      <th>Age</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>11978</th>
      <td>2.051410e+09</td>
      <td>NaN</td>
      <td>300</td>
      <td>BAYCHESTER AVENUE</td>
      <td>10475</td>
      <td>Bronx</td>
      <td>In Violation</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>11979</th>
      <td>3.088400e+09</td>
      <td>NaN</td>
      <td>3939</td>
      <td>SHORE PARKWAY</td>
      <td>11235</td>
      <td>Brooklyn</td>
      <td>In Violation</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>11980</th>
      <td>3.088420e+09</td>
      <td>NaN</td>
      <td>2824</td>
      <td>PLUMB    3 STREET</td>
      <td>11235</td>
      <td>Brooklyn</td>
      <td>In Violation</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>11981</th>
      <td>2.051411e+09</td>
      <td>NaN</td>
      <td>2100</td>
      <td>BARTOW AVENUE</td>
      <td>10475</td>
      <td>Bronx</td>
      <td>In Violation</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>11982</th>
      <td>2.051410e+09</td>
      <td>NaN</td>
      <td>312</td>
      <td>BAYCHESTER AVENUE</td>
      <td>10475</td>
      <td>Bronx</td>
      <td>In Violation</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 22 columns</p>
</div>
<p>There&rsquo;s not much we can learn from this, if we can look to see if certain zip codes have more buildings in violation.  First thing we do is group by the zip codes and count them to get the number of violations per zip code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>zips_df <span style="color:#f92672">=</span> Violators<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#39;Zip_Code&#39;</span>)[<span style="color:#e6db74">&#39;Zip_Code&#39;</span>]<span style="color:#f92672">.</span>size()\
</span></span><span style="display:flex;"><span>                   <span style="color:#f92672">.</span>reset_index(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;counts&#39;</span>)
</span></span></code></pre></div><p>Now we want to visualize the the number of violators per zip code. To make things interesting we will create an interactive choropleth map using the <a href="https://bokeh.pydata.org/en/latest/">Bokeh</a> Library.  Bokeh is a great vizualization tool that I have used in the <a href="http://michael-harmon.com/blog/IntroToBokeh.html">past</a>.  We get the shapes for New York City zip codes as a geojson file from this <a href="http://data.beta.nyc/dataset/nyc-zip-code-tabulation-areas">site</a>.  The geojson file can be read into a dataframe using <a href="http://geopandas.org/">GeoPandas</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> geopandas <span style="color:#66d9ef">as</span> gpd
</span></span><span style="display:flex;"><span>gdf <span style="color:#f92672">=</span> gpd<span style="color:#f92672">.</span>read_file(<span style="color:#e6db74">&#34;../data/nyc-zip-code-tabulation-areas-polygons.geojson&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># GeoPandas doesn&#39;t allow users to convert the datatype while reading it in so we do it here</span>
</span></span><span style="display:flex;"><span>gdf[<span style="color:#e6db74">&#34;postalCode&#34;</span>] <span style="color:#f92672">=</span> gdf[<span style="color:#e6db74">&#34;postalCode&#34;</span>]<span style="color:#f92672">.</span>astype(int)
</span></span></code></pre></div><p>We can see the basic contents of the GeoPandas dataframe:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>gdf<span style="color:#f92672">.</span>head(<span style="color:#ae81ff">2</span>)
</span></span></code></pre></div><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>OBJECTID</th>
      <th>postalCode</th>
      <th>PO_NAME</th>
      <th>STATE</th>
      <th>borough</th>
      <th>ST_FIPS</th>
      <th>CTY_FIPS</th>
      <th>BLDGpostal</th>
      <th>@id</th>
      <th>longitude</th>
      <th>latitude</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>11372</td>
      <td>Jackson Heights</td>
      <td>NY</td>
      <td>Queens</td>
      <td>36</td>
      <td>081</td>
      <td>0</td>
      <td>http://nyc.pediacities.com/Resource/PostalCode...</td>
      <td>-73.883573</td>
      <td>40.751662</td>
      <td>POLYGON ((-73.86942457284177 40.74915687096788...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>11004</td>
      <td>Glen Oaks</td>
      <td>NY</td>
      <td>Queens</td>
      <td>36</td>
      <td>081</td>
      <td>0</td>
      <td>http://nyc.pediacities.com/Resource/PostalCode...</td>
      <td>-73.711608</td>
      <td>40.745366</td>
      <td>POLYGON ((-73.71132911125308 40.74947450816085...</td>
    </tr>
  </tbody>
</table>
</div>
<p>I noticed only a few of the zipcodes had actual names, so I wrote a script (<code>GetNeighborhoodNames.py</code>) to scrape <a href="https://www.health.ny.gov/statistics/cancer/registry/appendix/neighborhoods.htm">this website</a> to obtain each neighborhood&rsquo;s name.  I pickled the results so we could use them here:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>zip_names <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_pickle(<span style="color:#e6db74">&#34;../data/neighborhoods.pkl&#34;</span>)
</span></span></code></pre></div><p>We can attach them to our GeoPandas dataframe by joining them (on zip code),</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>gdf <span style="color:#f92672">=</span> gdf<span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#39;PO_NAME&#39;</span>],axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)\
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">.</span>merge(zip_names, on<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;postalCode&#34;</span>,how<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;left&#34;</span>)\
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">.</span>fillna(<span style="color:#e6db74">&#34;&#34;</span>)
</span></span></code></pre></div><p>Next, we&rsquo;ll left join our count of violators-per-zipcode <code>zips_df</code> to above dataframe and fill in the zip codes that do not have violations with zeros:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>gdf<span style="color:#f92672">=</span> gdf<span style="color:#f92672">.</span>merge(zips_df, how<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;left&#34;</span>, left_on<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;postalCode&#34;</span>, right_on<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Zip_Code&#34;</span>)\
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#34;OBJECTID&#34;</span>,<span style="color:#e6db74">&#34;Zip_Code&#34;</span>], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)\
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">.</span>fillna(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>gdf<span style="color:#f92672">.</span>head(<span style="color:#ae81ff">2</span>)   
</span></span></code></pre></div><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>postalCode</th>
      <th>STATE</th>
      <th>borough</th>
      <th>ST_FIPS</th>
      <th>CTY_FIPS</th>
      <th>BLDGpostal</th>
      <th>@id</th>
      <th>longitude</th>
      <th>latitude</th>
      <th>geometry</th>
      <th>PO_NAME</th>
      <th>counts</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>11372</td>
      <td>NY</td>
      <td>Queens</td>
      <td>36</td>
      <td>081</td>
      <td>0</td>
      <td>http://nyc.pediacities.com/Resource/PostalCode...</td>
      <td>-73.883573</td>
      <td>40.751662</td>
      <td>POLYGON ((-73.86942457284177 40.74915687096788...</td>
      <td>West Queens</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>11004</td>
      <td>NY</td>
      <td>Queens</td>
      <td>36</td>
      <td>081</td>
      <td>0</td>
      <td>http://nyc.pediacities.com/Resource/PostalCode...</td>
      <td>-73.711608</td>
      <td>40.745366</td>
      <td>POLYGON ((-73.71132911125308 40.74947450816085...</td>
      <td>Southeast Queens</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>
<p>Now before we can use Bokeh to visualize our data we must first convert the GeoPandas dataframe to a format that Bokeh can work with. Since I already covered this in a previous blog <a href="http://michael-harmon.com/blog/IntroToBokeh.html">post</a> I won&rsquo;t go over the details, but here I used a slightly modified version of the function from that post:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>bokeh_source <span style="color:#f92672">=</span> convert_GeoPandas_to_Bokeh_format(gdf)
</span></span></code></pre></div><p>Next we set bokeh <code>io</code> module to be in the notebook and use the function I wrote <code>make_interactive_choropleth_map</code> to create the in-notebook zipcode choropleth map:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> bokeh.io <span style="color:#f92672">import</span> output_notebook, show
</span></span><span style="display:flex;"><span>output_notebook()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># We get the min and max of the number of violations to give the cloropleth a scale.</span>
</span></span><span style="display:flex;"><span>max_num_violations <span style="color:#f92672">=</span> zips_df[<span style="color:#e6db74">&#39;counts&#39;</span>]<span style="color:#f92672">.</span>max()
</span></span><span style="display:flex;"><span>min_num_violations <span style="color:#f92672">=</span> zips_df[<span style="color:#e6db74">&#39;counts&#39;</span>]<span style="color:#f92672">.</span>min()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fig <span style="color:#f92672">=</span> make_interactive_choropleth_map(bokeh_source,
</span></span><span style="display:flex;"><span>                                      count_var <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Number Of Violations&#34;</span>,
</span></span><span style="display:flex;"><span>                                      min_ct    <span style="color:#f92672">=</span> min_num_violations,
</span></span><span style="display:flex;"><span>                                      max_ct    <span style="color:#f92672">=</span> max_num_violations)
</span></span><span style="display:flex;"><span>show(fig)
</span></span></code></pre></div><img src="https://github.com/mdh266/NYCBuildingEnergyUse/blob/master/notebooks/images/nycbokeh.png?raw=1">
<p>You can hover your mouse over the each of the zipcode and the map will display the neighborhood name and number of violations. From this we can see that Chelsea, Downtown Brooklyn and Long Island City neighborhood have the highes number of violations.</p>
<p>The fact that different neighborhoods have different numbers of violating buildings gives us the suspicion that <strong>the neighborhood may be correlated with the buildings energy usage</strong>, this could be because of building owners that are in voliation owning multiple buildings on a single lot or neighrborhood.</p>
<p>Now let&rsquo;s move back to analyzing the buidlings that are not in violation.  First let&rsquo;s see the distributution of all buildings that are in different ranges of the <code>Energy Star</code> ratings:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>bins <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">20</span>,<span style="color:#ae81ff">30</span>,<span style="color:#ae81ff">40</span>,<span style="color:#ae81ff">50</span>,<span style="color:#ae81ff">60</span>,<span style="color:#ae81ff">70</span>,<span style="color:#ae81ff">80</span>,<span style="color:#ae81ff">90</span>,<span style="color:#ae81ff">100</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>df_2016_2[<span style="color:#e6db74">&#39;Energy_Star&#39;</span>]<span style="color:#f92672">.</span>value_counts(bins<span style="color:#f92672">=</span>bins)\
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">.</span>sort_index()\
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">.</span>plot(kind    <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;bar&#39;</span>,
</span></span><span style="display:flex;"><span>                              rot     <span style="color:#f92672">=</span> <span style="color:#ae81ff">35</span>,
</span></span><span style="display:flex;"><span>                              figsize <span style="color:#f92672">=</span> (<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">4</span>),
</span></span><span style="display:flex;"><span>                              title   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Frequency of ENERGY STAR Ratings&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;Frequency&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;ENERGY STAR Score&#39;</span>)
</span></span></code></pre></div><pre><code>Text(0.5, 0, 'ENERGY STAR Score')
</code></pre>
<p><img src="/greenbuildings1_files/greenbuildings1_29_1.png" alt="png"></p>
<p>We can see that the majority are within the 50-100 range, but a almost 1000 buildings have scores inbetween 0 and 10. Let&rsquo;s take a look at the distribution of building types.  We will just take the top 10 most common building types for now..</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>df_2016_2[<span style="color:#e6db74">&#39;Property_Type&#39;</span>]<span style="color:#f92672">.</span>value_counts()\
</span></span><span style="display:flex;"><span>                          <span style="color:#f92672">.</span>head(<span style="color:#ae81ff">10</span>)\
</span></span><span style="display:flex;"><span>                          <span style="color:#f92672">.</span>plot(kind     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;bar&#39;</span>,
</span></span><span style="display:flex;"><span>                                figsize  <span style="color:#f92672">=</span> (<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">4.5</span>),
</span></span><span style="display:flex;"><span>                                fontsize <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>,
</span></span><span style="display:flex;"><span>                                rot      <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;Frequency of building type&#39;</span>, fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">13</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;Building Type&#39;</span>, fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">13</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;Frequency&#39;</span>, fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">13</span>)
</span></span></code></pre></div><pre><code>Text(0, 0.5, 'Frequency')
</code></pre>
<p><img src="/greenbuildings1_files/greenbuildings1_31_1.png" alt="png"></p>
<p>The most common buildings in NYC are multifamily housing, then offices, other, hotels and somewhat suprisingly non-refrigerated warehouse space.  I would have thought that there would be more schools and retail spaces than warehouses or dormitorites in New York City, but I don&rsquo;t know what the <code>Primary BBL</code> listing is.</p>
<p>Let&rsquo;s look at the Energy Star ratings of buildings across different building types, but first how many different building types are there?  We can find this out,</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Number of building types are: </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(len(df_2016_2[<span style="color:#e6db74">&#39;Property_Type&#39;</span>]<span style="color:#f92672">.</span>unique())))
</span></span></code></pre></div><pre><code>Number of building types are: 54
</code></pre>
<p>This is too many building types to visualize the Energy Star Score (<code>Energy_Star</code>) of each, we&rsquo;ll just look at just 5 building types, lumping the 54 into the categories into either:</p>
<ul>
<li>Residential</li>
<li>Office</li>
<li>Retail</li>
<li>Storage</li>
<li>Other</li>
</ul>
<p>I built a function to group the buildings into the 5 types above called <code>clean_property_type(&hellip;)</code> and we use it below to transform the Pandas Series:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>Property_Type <span style="color:#f92672">=</span> df_2016_2<span style="color:#f92672">.</span>copy()
</span></span><span style="display:flex;"><span>Property_Type[<span style="color:#e6db74">&#39;Property_Type&#39;</span>] <span style="color:#f92672">=</span> Property_Type[<span style="color:#e6db74">&#39;Property_Type&#39;</span>]<span style="color:#f92672">.</span>apply(group_property_types)
</span></span></code></pre></div><p>Now we can look at the  <code>Energy_Star</code> (score) of each of the grouped buildings types:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>bins2 <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">20</span>,<span style="color:#ae81ff">35</span>,<span style="color:#ae81ff">50</span>,<span style="color:#ae81ff">65</span>,<span style="color:#ae81ff">80</span>,<span style="color:#ae81ff">100</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Energy_Star_Scores <span style="color:#f92672">=</span> Property_Type<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;Property_Type&#39;</span>])[<span style="color:#e6db74">&#39;Energy_Star&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Energy_Star_Scores<span style="color:#f92672">.</span>value_counts(bins<span style="color:#f92672">=</span>bins2)\
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">.</span>sort_index()\
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">.</span>plot(kind<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bar&#39;</span>,
</span></span><span style="display:flex;"><span>                        figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">13</span>,<span style="color:#ae81ff">6</span>),
</span></span><span style="display:flex;"><span>                        fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">13</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;Frequency of Energy Star Score by building type&#39;</span>,fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">14</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;Building Type and Energy Star&#39;</span>, fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">13</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;Frequency&#39;</span>, fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">13</span>)
</span></span></code></pre></div><pre><code>Text(0, 0.5, 'Frequency')
</code></pre>
<p><img src="/greenbuildings1_files/greenbuildings1_37_1.png" alt="png"></p>
<p>Overall it looks like residential buildings have a lot more proportion of low Energy Star Scoring buildings when compared to office buildings. This is probably because there are much more older residential buildings than office spaces in New York City. We&rsquo;ll look at the distribution of the years in which builings of just properties of type: &lsquo;Multifamily Housing&rsquo; and &lsquo;Office&rsquo; were built:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>plot_years_built(df_2016_2)
</span></span></code></pre></div><p><img src="/greenbuildings1_files/greenbuildings1_39_0.png" alt="png"></p>
<p>It seems like it&rsquo;s the opposite of what I thought, but the number of residential buildings is much higher and the majority were built right before and right after World War 2, as well as in the 2000s.  The same is true about offices, however, without the uptick in the early 2000s.</p>
<h2 id="connecting-to-bigquery">
  Connecting To BigQuery <a class="anchor" id="third-bullet"></a>
  <a class="heading-link" href="#connecting-to-bigquery">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<hr>
<p>Let&rsquo;s focus on the multifamily housing and office buildings to see what we can find out about them since these make up the majority of buildings and may offer the best return on investment in terms of improving energy efficiency. Let&rsquo;s create our dataset focusing on the fields:</p>
<pre><code>- Energy Star 
- Site Energy Usage Intensity (Site_EUI)
- Natural Gas Intensity (NGI)
- Eletricity Intensity (EI)
- Water Intensity (WI)
- Green House Gas Intensity (GHGI)
- Occupancy Per Sq Ft (OPSFT)
- Age 
- Residential (1 or 0 if true or false)
</code></pre>
<p>We choose these fields as they should be independent of size of the building and therefore comparable across buildings.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>Buildings <span style="color:#f92672">=</span> df_2016_2[df_2016_2[<span style="color:#e6db74">&#39;Property_Type&#39;</span>]<span style="color:#f92672">.</span>isin([<span style="color:#e6db74">&#39;Office&#39;</span>,<span style="color:#e6db74">&#39;Multifamily Housing&#39;</span>])]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Buildings <span style="color:#f92672">=</span> Buildings<span style="color:#f92672">.</span>merge(pd<span style="color:#f92672">.</span>get_dummies(Buildings[<span style="color:#e6db74">&#34;Property_Type&#34;</span>])[[<span style="color:#e6db74">&#34;Multifamily Housing&#34;</span>]]
</span></span><span style="display:flex;"><span>                              <span style="color:#f92672">.</span>rename(columns<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;Multifamily Housing&#34;</span>:<span style="color:#e6db74">&#34;Residential&#34;</span>}),
</span></span><span style="display:flex;"><span>                            left_index<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>                            right_index<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>                            
</span></span><span style="display:flex;"><span>columns   <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;Energy_Star&#34;</span>, <span style="color:#e6db74">&#34;Site_EUI&#34;</span>, <span style="color:#e6db74">&#34;NGI&#34;</span>, <span style="color:#e6db74">&#34;EI&#34;</span>, <span style="color:#e6db74">&#34;WI&#34;</span>, 
</span></span><span style="display:flex;"><span>             <span style="color:#e6db74">&#34;GHGI&#34;</span>, <span style="color:#e6db74">&#34;OPSFT&#34;</span>, <span style="color:#e6db74">&#34;Age&#34;</span>, <span style="color:#e6db74">&#34;Residential&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Buildings <span style="color:#f92672">=</span> Buildings[columns]
</span></span></code></pre></div><p>Now since I will be working on this project over a few days I write this data to table so I won&rsquo;t have to constantly load and clean it again and again.  Since I&rsquo;m using the <a href="https://cloud.google.com/"  class="external-link" target="_blank" rel="noopener">Google Cloud Platform</a>, I&rsquo;ll using <a href="https://cloud.google.com/bigquery"  class="external-link" target="_blank" rel="noopener">BigQuery</a> for storing my data.  This requires that I have credentials.  I used the <a href="https://pypi.org/project/google-auth-oauthlib/"  class="external-link" target="_blank" rel="noopener">google-auth-oauthlib</a> package and followed the instructions <a href="https://cloud.google.com/bigquery/docs/authentication/end-user-installed"  class="external-link" target="_blank" rel="noopener">here</a> to create a credentials json file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> google.oauth2 <span style="color:#f92672">import</span> service_account
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>credentials <span style="color:#f92672">=</span> service_account<span style="color:#f92672">.</span>Credentials\
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">.</span>from_service_account_file(<span style="color:#e6db74">&#39;./derby.json&#39;</span>)
</span></span></code></pre></div><p>Next I installed <a href="https://pandas-gbq.readthedocs.io/en/latest/"  class="external-link" target="_blank" rel="noopener">pandas-gbq</a> for connecting Pandas and BigQuery and set my credentials and project:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas_gbq 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pandas_gbq<span style="color:#f92672">.</span>context<span style="color:#f92672">.</span>credentials <span style="color:#f92672">=</span> credentials
</span></span><span style="display:flex;"><span>pandas_gbq<span style="color:#f92672">.</span>context<span style="color:#f92672">.</span>project     <span style="color:#f92672">=</span> credentials<span style="color:#f92672">.</span>project_id
</span></span></code></pre></div><p>Then I created a table <code>raw_data</code> in the database <code>db_gb</code> using the <a href="https://pandas-gbq.readthedocs.io/en/latest/writing.html"  class="external-link" target="_blank" rel="noopener">to_gbq</a> function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>pandas_gbq<span style="color:#f92672">.</span>to_gbq(Buildings, 
</span></span><span style="display:flex;"><span>                  <span style="color:#e6db74">&#34;db_gb.raw_data&#34;</span>)
</span></span></code></pre></div><p>And were done! We can query the data from the BigQuery UI as shown below:</p>
<img src="https://github.com/mdh266/NYCBuildingEnergyUse/blob/master/notebooks/images/bigquery.png?raw=1">
<p>Let&rsquo;s move onto removing outliers.</p>
<p>Firs thing we need to do is to get the data from BigQuery as a Pandas dataframe.  We use the <a href="https://pandas-gbq.readthedocs.io/en/latest/reading.html"  class="external-link" target="_blank" rel="noopener">read_gbq</a> function from pandas_gbq:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>X <span style="color:#f92672">=</span> pandas_gbq<span style="color:#f92672">.</span>read_gbq(<span style="color:#e6db74">&#34;&#34;&#34;SELECT 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                               Energy_Star,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                               Site_EUI,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                               NGI,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                               EI,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                               WI,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                               GHGI,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                               OPSFT,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                               Age,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                               Residential,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            FROM 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                                db_gb.raw_data 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;&#34;&#34;</span>)
</span></span></code></pre></div><pre><code>Downloading: 100%|██████████| 9932/9932 [00:01&lt;00:00, 7928.89rows/s]
</code></pre>
<p>We can then look at the distribution of values in the dataframe:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>X<span style="color:#f92672">.</span>describe()
</span></span></code></pre></div><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Energy_Star</th>
      <th>Site_EUI</th>
      <th>NGI</th>
      <th>EI</th>
      <th>WI</th>
      <th>GHGI</th>
      <th>OPSFT</th>
      <th>Age</th>
      <th>Residential</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>8617.000000</td>
      <td>9879.000000</td>
      <td>8527.000000</td>
      <td>9656.000000</td>
      <td>6281.000000</td>
      <td>9686.000000</td>
      <td>9720.000000</td>
      <td>9932.000000</td>
      <td>9932.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>58.403505</td>
      <td>495.677558</td>
      <td>150.094551</td>
      <td>41.164075</td>
      <td>0.099990</td>
      <td>0.028340</td>
      <td>0.001078</td>
      <td>68.944724</td>
      <td>0.875856</td>
    </tr>
    <tr>
      <th>std</th>
      <td>29.968956</td>
      <td>10494.559237</td>
      <td>8081.609124</td>
      <td>807.887239</td>
      <td>0.852744</td>
      <td>0.582040</td>
      <td>0.000535</td>
      <td>29.120410</td>
      <td>0.329763</td>
    </tr>
    <tr>
      <th>min</th>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>-2.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>35.000000</td>
      <td>67.100000</td>
      <td>7.182433</td>
      <td>13.636592</td>
      <td>0.031498</td>
      <td>0.004417</td>
      <td>0.000641</td>
      <td>53.000000</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>63.000000</td>
      <td>82.400000</td>
      <td>48.764998</td>
      <td>17.831709</td>
      <td>0.047561</td>
      <td>0.005447</td>
      <td>0.001095</td>
      <td>77.000000</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>84.000000</td>
      <td>101.200000</td>
      <td>68.696570</td>
      <td>26.824484</td>
      <td>0.073500</td>
      <td>0.006836</td>
      <td>0.001536</td>
      <td>90.000000</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>100.000000</td>
      <td>801504.700000</td>
      <td>737791.764249</td>
      <td>65067.140501</td>
      <td>52.143200</td>
      <td>39.190314</td>
      <td>0.001999</td>
      <td>417.000000</td>
      <td>1.000000</td>
    </tr>
  </tbody>
</table>
</div>
<p>We can see again, large variations in the energy data, with most of it being between 0 and some fixed number with atleast one outlier.  For example, the minimum age of a building is -2, which is absurd!  We can also see from the varying &ldquo;count&rdquo; values that there are a significant number of missing values.  Let&rsquo;s find out just how many buildings have atleast one missing value:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>X_nna <span style="color:#f92672">=</span> X<span style="color:#f92672">.</span>dropna()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Total Buildings: </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(X<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]))
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Total Buildings without any missing data: </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(X_nna<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]))
</span></span></code></pre></div><pre><code>Total Buildings: 9932
Total Buildings without any missing data: 4880
</code></pre>
<p>About half of the buildings have missing data! We&rsquo;ll first deal with removing outliers and then after that work on imputing missing values in the next post.</p>
<p>Let&rsquo;s plot the correlation matrix to see how correlated are features are on the all the buildings. Note that we first have to normalize the data.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> sklearn.preprocessing <span style="color:#f92672">import</span> StandardScaler
</span></span><span style="display:flex;"><span>scaler1 <span style="color:#f92672">=</span> StandardScaler()
</span></span><span style="display:flex;"><span>Xs      <span style="color:#f92672">=</span> scaler1<span style="color:#f92672">.</span>fit_transform(X)
</span></span><span style="display:flex;"><span>xs_df   <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(Xs, columns<span style="color:#f92672">=</span>X<span style="color:#f92672">.</span>columns)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">8</span>,<span style="color:#ae81ff">6</span>))  
</span></span><span style="display:flex;"><span>sns<span style="color:#f92672">.</span>color_palette(<span style="color:#e6db74">&#34;BuGn_r&#34;</span>,)
</span></span><span style="display:flex;"><span>sns<span style="color:#f92672">.</span>heatmap(xs_df<span style="color:#f92672">.</span>corr(),
</span></span><span style="display:flex;"><span>            linewidths<span style="color:#f92672">=</span><span style="color:#ae81ff">.5</span>,
</span></span><span style="display:flex;"><span>            cmap<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;RdBu_r&#34;</span>)
</span></span></code></pre></div><pre><code>&lt;AxesSubplot:&gt;
</code></pre>
<p><img src="/greenbuildings1_files/greenbuildings1_57_1.png" alt="png"></p>
<p>We can see that,</p>
<ul>
<li>
<p><strong>Natural gas usage is fairly strongly correlated to green house emission rates which makes sense.</strong></p>
</li>
<li>
<p><strong>Energy usage intensity is strongly correlated with natural gas intensity and greenhouse gas emissions. These make sense, since gas is a primary form of heating.</strong></p>
</li>
</ul>
<p>What doesn&rsquo;t make sense to me is that <em>the energy star score is weakly correlated to any of the measures of energy, water or emissions</em>.  This is strange to me because a higher energy star score is supposed to reflect more efficient use of energy and water.  Furthermore, the energy star score goes up (slightly) as the age increases which doesn&rsquo;t make sense as the I would expect older homes to be less energy efficient.</p>
<p>We can see how the results change when we only use building data that does not have missing values:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>Xs_nna_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(StandardScaler()<span style="color:#f92672">.</span>fit_transform(X_nna), 
</span></span><span style="display:flex;"><span>                           columns<span style="color:#f92672">=</span>X_nna<span style="color:#f92672">.</span>columns)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">8</span>,<span style="color:#ae81ff">6</span>))  
</span></span><span style="display:flex;"><span>sns<span style="color:#f92672">.</span>color_palette(<span style="color:#e6db74">&#34;BuGn_r&#34;</span>,)
</span></span><span style="display:flex;"><span>sns<span style="color:#f92672">.</span>heatmap(Xs_nna_df<span style="color:#f92672">.</span>corr(),
</span></span><span style="display:flex;"><span>            linewidths<span style="color:#f92672">=</span><span style="color:#ae81ff">.5</span>,
</span></span><span style="display:flex;"><span>            cmap<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;RdBu_r&#34;</span>)
</span></span></code></pre></div><pre><code>&lt;AxesSubplot:&gt;
</code></pre>
<p><img src="/greenbuildings1_files/greenbuildings1_59_1.png" alt="png"></p>
<p>The previously mentioned correlations are now stronger, but there is still too weak a correlation between energy star score and energy or water usage for my liking.  We&rsquo;ll have to dig deeper into the data to see if there are outliers that are affecting our correlation matrix.</p>
<h2 id="removing-visual-outliers">
  Removing Visual Outliers <a class="anchor" id="fourth-bullet"></a>
  <a class="heading-link" href="#removing-visual-outliers">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<hr>
<p>In this section we&rsquo;ll be looking at box plots and scatter plots of various features against the <code>Site_EUI</code> variable to try to identify outliers in the data. We&rsquo;ll first look at box plots, separating out <code>Age</code> and energy metrics as they are very different scales.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">5</span>))
</span></span><span style="display:flex;"><span>sns<span style="color:#f92672">.</span>boxplot(data<span style="color:#f92672">=</span>X[[<span style="color:#e6db74">&#34;Energy_Star&#34;</span>,<span style="color:#e6db74">&#34;Age&#34;</span>,<span style="color:#e6db74">&#34;WI&#34;</span>,<span style="color:#e6db74">&#34;GHGI&#34;</span>,]])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">5</span>))
</span></span><span style="display:flex;"><span>sns<span style="color:#f92672">.</span>boxplot(data<span style="color:#f92672">=</span>X[[<span style="color:#e6db74">&#34;Site_EUI&#34;</span>,<span style="color:#e6db74">&#34;NGI&#34;</span>,<span style="color:#e6db74">&#34;EI&#34;</span>]])
</span></span></code></pre></div><pre><code>&lt;AxesSubplot:&gt;
</code></pre>
<p><img src="/greenbuildings1_files/greenbuildings1_62_1.png" alt="png"></p>
<p><img src="/greenbuildings1_files/greenbuildings1_62_2.png" alt="png"></p>
<p>We can see that there are a TON of outliers in all of the fields except <code>Energy_Star</code> and <code>Age</code>.  Our strategy for removing the outliers will be to use scatter plots of various the metrics against the <code>Site_EUI</code> as their should be a natural relationship between them. For the purposes of this removing outliers let&rsquo;s focus on just <code>NGI</code>,<code>EI</code>,<code>WI</code>, and <code>GHGI</code> as we expect these correlated to <code>Site_EUI</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sns<span style="color:#f92672">.</span>pairplot(X, 
</span></span><span style="display:flex;"><span>             x_vars<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;NGI&#39;</span>,<span style="color:#e6db74">&#39;EI&#39;</span>,<span style="color:#e6db74">&#39;WI&#39;</span>,<span style="color:#e6db74">&#39;GHGI&#39;</span>,<span style="color:#e6db74">&#39;Age&#39;</span>,<span style="color:#e6db74">&#39;Energy_Star&#39;</span>], 
</span></span><span style="display:flex;"><span>             y_vars<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;Site_EUI&#39;</span>], 
</span></span><span style="display:flex;"><span>             kind <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;reg&#39;</span>,
</span></span><span style="display:flex;"><span>             size<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>, 
</span></span><span style="display:flex;"><span>             dropna<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><pre><code>&lt;seaborn.axisgrid.PairGrid at 0x7fd3bed84fd0&gt;
</code></pre>
<p><img src="/greenbuildings1_files/greenbuildings1_64_1.png" alt="png"></p>
<p>Definitely a lot of outliers! We&rsquo;ll go through each of the individual scatter plots to find outliers each of the fields.</p>
<p>Let&rsquo;s first look at the scatter plot of natural gas intensity and energy usage intensity to see if we can observe outliers that may be affecting our correlation matrix.  <em>The reason we are doing so is that we suspect energy usage intensity should be highly correlated to natural gas intensity since natural gas is used for cooking and heating.</em></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sns<span style="color:#f92672">.</span>pairplot(X, 
</span></span><span style="display:flex;"><span>             x_vars<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;NGI&#39;</span>,
</span></span><span style="display:flex;"><span>             y_vars<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Energy_Star&#39;</span>,
</span></span><span style="display:flex;"><span>             kind<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;reg&#39;</span>,
</span></span><span style="display:flex;"><span>             size<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>,
</span></span><span style="display:flex;"><span>             dropna<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><pre><code>&lt;seaborn.axisgrid.PairGrid at 0x7f8a01305bd0&gt;
</code></pre>
<p><img src="/greenbuildings1_files/greenbuildings1_66_1.png" alt="png"></p>
<p>We can see at least one extreme outlier! Looking at the box plot of values we can see that most of the values for NGI are under 100,000. Let&rsquo;s try that as starting point and remove values above 100,000 to see if there is a clearer relationship between the natural gas usage and EUI:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sns<span style="color:#f92672">.</span>pairplot(X<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#34;NGI &lt; 100000&#34;</span>), 
</span></span><span style="display:flex;"><span>             x_vars<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;NGI&#39;</span>,
</span></span><span style="display:flex;"><span>             y_vars<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Site_EUI&#39;</span>,
</span></span><span style="display:flex;"><span>             kind<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;reg&#39;</span>,
</span></span><span style="display:flex;"><span>             size<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>,
</span></span><span style="display:flex;"><span>             dropna<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><pre><code>&lt;seaborn.axisgrid.PairGrid at 0x7f8a02286ed0&gt;
</code></pre>
<p><img src="/greenbuildings1_files/greenbuildings1_68_1.png" alt="png"></p>
<p>Still a significant number of outliers that need to be removed. We could use domain knowledge if we have it on what are reasonable range of values for <code>NGI</code>. Since I don&rsquo;t have that knowledge I experimented with different values and was able find a number that gave me a reasonable relationship:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sns<span style="color:#f92672">.</span>pairplot(X<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#34;NGI &lt; 1e3 &amp; Site_EUI &lt; 1e3&#34;</span>),
</span></span><span style="display:flex;"><span>             x_vars<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;NGI&#39;</span>,
</span></span><span style="display:flex;"><span>             y_vars<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Site_EUI&#39;</span>,
</span></span><span style="display:flex;"><span>             kind<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;reg&#39;</span>,
</span></span><span style="display:flex;"><span>             size<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>,
</span></span><span style="display:flex;"><span>             dropna<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><pre><code>&lt;seaborn.axisgrid.PairGrid at 0x7f8a0122efd0&gt;
</code></pre>
<p><img src="/greenbuildings1_files/greenbuildings1_70_1.png" alt="png"></p>
<p>We can see that <strong>buildings that have higher natural gas usage per sqft have a higher energy intensity and this makes sense!</strong></p>
<p>We could repeat the same procedure for the other variables, but this can get tiresome searching for good filters. I recently found another way to get better values for filters which we&rsquo;ll go over next.</p>
<h2 id="removing-outliers-with-isolation-forests">
  Removing Outliers With Isolation Forests <a class="anchor" id="fifth-bullet"></a>
  <a class="heading-link" href="#removing-outliers-with-isolation-forests">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<hr>
<p>An <a href="https://en.wikipedia.org/wiki/Isolation_forest"  class="external-link" target="_blank" rel="noopener">Isolation Forest</a> is an unsuperised method that uses an collection of decision trees to identify outliers in a dataset. The algorithm works by exploiting that fact that outliers are rare and most datapoints that are normal have similar feature values. The algorithm is able to label data points into outliers and normal points by recursively generating partitions on the dataset through randomly choosing features and its splitting values. The partitions are recursively created until a single data point is in the partition or all the points in the partitions have the same value.</p>
<p>A diagram of the recursive partitioning is shown below:</p>
<figure>
<img src="https://github.com/mdh266/NYCBuildingEnergyUse/blob/master/notebooks/images/iforest.png?raw=1">
<caption>*From https://en.wikipedia.org/wiki/Isolation_forest* </caption>
</figure>
<p>This recursively partitioning can be respresented as a tree and the length of the path from the root to the terminal node can be treated as a measure of normality. Points that require relatively few partitions and have relatively a small length to their terminal node (such as <span class="katex"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">X_j</annotation></semantics></math></span>
 above) are considered outliers. When a forest of trees says the average depth to isolate a datapoint is small it&rsquo;s then flagged as a outlier by the model.</p>
<p>Scikit-learn has an implementation of <a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.IsolationForest.html"  class="external-link" target="_blank" rel="noopener">Isolation Forests</a> that we will make use of to determine reasonable filters for outliers. One thing to notice is that there cannot be any missing values in the dataset when we fit the model:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> sklearn.ensemble <span style="color:#f92672">import</span> IsolationForest
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>iforest <span style="color:#f92672">=</span> IsolationForest()<span style="color:#f92672">.</span>fit(X_nna)
</span></span></code></pre></div><p>I found that default settings in Scikit-learn worked quite well and didn&rsquo;t need to tune it all. We can now use that model to label points as outliers (-1) or normal (1) and the look at the scatter plot for the new feature values</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>X_nna[<span style="color:#e6db74">&#34;outlier&#34;</span>] <span style="color:#f92672">=</span> iforest<span style="color:#f92672">.</span>predict(X_nna) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>X_noo <span style="color:#f92672">=</span> X_nna<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#34;outlier == 1&#34;</span>)<span style="color:#f92672">.</span>drop(<span style="color:#e6db74">&#34;outlier&#34;</span>, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sns<span style="color:#f92672">.</span>pairplot(X_noo, 
</span></span><span style="display:flex;"><span>             x_vars<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;NGI&#39;</span>,<span style="color:#e6db74">&#39;EI&#39;</span>,<span style="color:#e6db74">&#39;WI&#39;</span>,<span style="color:#e6db74">&#39;GHGI&#39;</span>,<span style="color:#e6db74">&#39;Age&#39;</span>,<span style="color:#e6db74">&#39;Energy_Star&#39;</span>], 
</span></span><span style="display:flex;"><span>             y_vars<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;Site_EUI&#39;</span>], 
</span></span><span style="display:flex;"><span>             kind <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;reg&#39;</span>,
</span></span><span style="display:flex;"><span>             size<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>, 
</span></span><span style="display:flex;"><span>             dropna<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><pre><code>&lt;seaborn.axisgrid.PairGrid at 0x7f89e6898c10&gt;
</code></pre>
<p><img src="/greenbuildings1_files/greenbuildings1_74_1.png" alt="png"></p>
<p>These look like much more reasonable relationships! Let&rsquo;s get the maximum values to find the filters for removing outliers:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>X_noo<span style="color:#f92672">.</span>describe()<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span></code></pre></div><pre><code>Energy_Star    100.000000
Site_EUI       180.200000
NGI            139.723077
EI              55.984183
WI               1.395016
GHGI             0.011523
OPSFT            0.001999
Age            167.000000
Residential      1.000000
Name: max, dtype: float64
</code></pre>
<p>We can use 140 as the upper bound for <code>NGI</code> and 180 for <code>Site_EUI</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sns<span style="color:#f92672">.</span>pairplot(X<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#34;NGI &lt;= 140 &amp; Site_EUI &lt;= 180&#34;</span>),
</span></span><span style="display:flex;"><span>             x_vars<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;NGI&#39;</span>,
</span></span><span style="display:flex;"><span>             y_vars<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Site_EUI&#39;</span>,
</span></span><span style="display:flex;"><span>             kind<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;reg&#39;</span>,
</span></span><span style="display:flex;"><span>             size<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>,
</span></span><span style="display:flex;"><span>             dropna<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><pre><code>&lt;seaborn.axisgrid.PairGrid at 0x7fd3bead56d0&gt;
</code></pre>
<p><img src="/greenbuildings1_files/greenbuildings1_78_1.png" alt="png"></p>
<p>We can see a much clearer relationship of <code>NGI</code> TO <code>Site_EUI</code>, where there seem to be a cluster of buildings with linear relationship and a cluster that has no relationship and is vertical.</p>
<p>Note that we can use the restriction on the original dataset (X) without removing the nulls. We can do the same thing for <code>EI</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sns<span style="color:#f92672">.</span>pairplot(X<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#34;NGI &lt;= 140 &amp; Site_EUI &lt;= 180 &amp; EI &lt;= 55&#34;</span>), 
</span></span><span style="display:flex;"><span>             x_vars<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;EI&#39;</span>, 
</span></span><span style="display:flex;"><span>             y_vars<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Site_EUI&#39;</span>, 
</span></span><span style="display:flex;"><span>             kind<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;reg&#39;</span>, 
</span></span><span style="display:flex;"><span>             size<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>,
</span></span><span style="display:flex;"><span>             dropna<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><pre><code>&lt;seaborn.axisgrid.PairGrid at 0x7f89e9882e90&gt;
</code></pre>
<p><img src="/greenbuildings1_files/greenbuildings1_80_1.png" alt="png"></p>
<p>The relationship is less obvious, but we can see that <strong>buildings with higher electricity per square foot have a higher energy usage intensity.</strong></p>
<p>Now we do the same for water usage intensity and EUI.  While it might not seem obvious that water usage could be correlated with energy usage intensity, I&rsquo;m thinking it may be becasue often water is used for heating and cooling.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sns<span style="color:#f92672">.</span>pairplot(X<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#34;NGI &lt;= 140 | Site_EUI &lt;= 180 &amp; EI &lt;= 55 &amp; WI &lt;= 1.4&#34;</span>),
</span></span><span style="display:flex;"><span>             x_vars<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;WI&#39;</span>, 
</span></span><span style="display:flex;"><span>             y_vars<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Site_EUI&#39;</span>,
</span></span><span style="display:flex;"><span>             kind<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;reg&#39;</span>,
</span></span><span style="display:flex;"><span>             size<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>, 
</span></span><span style="display:flex;"><span>             dropna<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><pre><code>&lt;seaborn.axisgrid.PairGrid at 0x7f89e9b44c10&gt;
</code></pre>
<p><img src="/greenbuildings1_files/greenbuildings1_82_1.png" alt="png"></p>
<p>Interestingly, here we see a weaker, but still positive correlation, meaning <strong>buildings which use more water per square foot only have marginarly higher energy usage intensity.</strong></p>
<p>Lastly we repeat the procedure for greenhouse gas emission intensity (<code>GHGI</code>), since I think that if a building is more energy intensive it would have a much larger carbon foot print. It turns out the filters already used were good enough and it didnt seem like there was too many outliers:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sns<span style="color:#f92672">.</span>pairplot(X<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#34;NGI &lt;= 140 &amp; Site_EUI &lt;= 180 &amp; EI &lt;= 55 &amp; WI &lt;= 1.4&#34;</span>),
</span></span><span style="display:flex;"><span>             x_vars<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;GHGI&#39;</span>, 
</span></span><span style="display:flex;"><span>             y_vars<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Site_EUI&#39;</span>,
</span></span><span style="display:flex;"><span>             kind<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;reg&#39;</span>,
</span></span><span style="display:flex;"><span>             size<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>, 
</span></span><span style="display:flex;"><span>             dropna<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><pre><code>&lt;seaborn.axisgrid.PairGrid at 0x7f89e8f03090&gt;
</code></pre>
<p><img src="/greenbuildings1_files/greenbuildings1_84_1.png" alt="png"></p>
<p>Over all there are not <em>too many outliers</em>! I can live with the data as is and not remove any more data points.</p>
<p>Let&rsquo;s take a look at the box plots again:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>X_noo_df <span style="color:#f92672">=</span> X<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#34;NGI &lt;= 140 &amp; Site_EUI &lt;= 180 &amp; EI &lt;= 55 &amp; WI &lt;= 1.4&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">3</span>))
</span></span><span style="display:flex;"><span>sns<span style="color:#f92672">.</span>boxplot(data<span style="color:#f92672">=</span>X_noo_df[[<span style="color:#e6db74">&#34;Energy_Star&#34;</span>,<span style="color:#e6db74">&#34;Age&#34;</span>,<span style="color:#e6db74">&#34;EI&#34;</span>]])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">3</span>))
</span></span><span style="display:flex;"><span>sns<span style="color:#f92672">.</span>boxplot(data<span style="color:#f92672">=</span>X_noo_df[[<span style="color:#e6db74">&#34;Site_EUI&#34;</span>,<span style="color:#e6db74">&#34;NGI&#34;</span>]])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">3</span>))
</span></span><span style="display:flex;"><span>sns<span style="color:#f92672">.</span>boxplot(data<span style="color:#f92672">=</span>X_noo_df[[<span style="color:#e6db74">&#34;WI&#34;</span>,<span style="color:#e6db74">&#34;GHGI&#34;</span>]])
</span></span></code></pre></div><pre><code>&lt;AxesSubplot:&gt;
</code></pre>
<p><img src="/greenbuildings1_files/greenbuildings1_86_1.png" alt="png"></p>
<p><img src="/greenbuildings1_files/greenbuildings1_86_2.png" alt="png"></p>
<p><img src="/greenbuildings1_files/greenbuildings1_86_3.png" alt="png"></p>
<p>The box plots show that there are still a lot of outliers, but I don&rsquo;t want to remove too many data points, just the most egregious outliers. Let&rsquo;s look at each of the correlations to see how were doing with the realtionships:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sns<span style="color:#f92672">.</span>pairplot(X_noo_df, 
</span></span><span style="display:flex;"><span>             x_vars<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;NGI&#39;</span>,<span style="color:#e6db74">&#39;EI&#39;</span>,<span style="color:#e6db74">&#39;WI&#39;</span>,<span style="color:#e6db74">&#39;GHGI&#39;</span>,<span style="color:#e6db74">&#39;Age&#39;</span>,<span style="color:#e6db74">&#39;Energy_Star&#39;</span>], 
</span></span><span style="display:flex;"><span>             y_vars<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;Site_EUI&#39;</span>], 
</span></span><span style="display:flex;"><span>             kind <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;reg&#39;</span>,
</span></span><span style="display:flex;"><span>             size<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>, 
</span></span><span style="display:flex;"><span>             dropna<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><pre><code>&lt;seaborn.axisgrid.PairGrid at 0x7f89eaea8e50&gt;
</code></pre>
<p><img src="/greenbuildings1_files/greenbuildings1_88_1.png" alt="png"></p>
<p>We can see these all make sense as mentioned before. The last correaltion <code>Site_EUI</code> vs <code>Energy_Star</code> which is somewhat nonlinear, but shows that as Enegery Star increases the site energy usage goes down and this makes sense!</p>
<p>It look&rsquo;s like EUI is very positively correlated to the green house gas emission intensity and natural gas usage intensity.  The relationship between EUI is slightly less strongly correlated to electricity usage intensity and even less so with water usage intensity.</p>
<p>We can also see from the plot below that the site <strong>EUI was not very correlated to the year that the buildings were constructed.</strong>  Most likely this is because so many were built around the same time period.</p>
<p>Now that we have removed some outliers we can visualize the correlation matrix to see if it makes more sense and gleam some insights into improving these building energy efficiency.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">8</span>,<span style="color:#ae81ff">6</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sns<span style="color:#f92672">.</span>heatmap(X_noo_df<span style="color:#f92672">.</span>corr(),
</span></span><span style="display:flex;"><span>            linewidths<span style="color:#f92672">=</span><span style="color:#ae81ff">.5</span>,
</span></span><span style="display:flex;"><span>            cmap<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;RdBu_r&#34;</span>)
</span></span></code></pre></div><pre><code>&lt;AxesSubplot:&gt;
</code></pre>
<p><img src="/greenbuildings1_files/greenbuildings1_92_1.png" alt="png"></p>
<p>This is a much more belivable correlation matrix than the previous two we looked at!!</p>
<p><em>We can see that the Energy Star score is very negatively correlated with enery usage intensity, which make sense as the energy star score is a measure of energy efficiceny of the building.</em> Furthermore the Energy Star score is negatively correlated with electricity, water, and natural gas usage intensity as well as green house gas emission intensity which makes sense. Additionally, we see that <strong>Energy Star Score is independent of occupancy per square foot which makes sense since it is a function of the building&rsquo;s efficiency and not the people inside of it.</strong></p>
<p>I&rsquo;m going to again write the results of outlier removeal to BigQuery so as not to have recompute everything again when I come back to this project for the next post.  This time however I will create new table by filtering on the raw data table:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> google.cloud <span style="color:#f92672">import</span> bigquery
</span></span><span style="display:flex;"><span>client <span style="color:#f92672">=</span> bigquery<span style="color:#f92672">.</span>Client(project     <span style="color:#f92672">=</span> credentials<span style="color:#f92672">.</span>project_id,
</span></span><span style="display:flex;"><span>                         credentials <span style="color:#f92672">=</span> credentials)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>job <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">CREATE TABLE db_gb.no_outlier_data
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">AS 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">SELECT
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   Energy_Star,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   Site_EUI,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   NGI,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   EI,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   WI,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   GHGI,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   OPSFT,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   Age,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   Residential,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">FROM 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    db_gb.raw_data 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WHERE 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    (NGI &lt;= 140 OR NGI IS NULL)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">AND (EI &lt;= 60 OR EI IS NULL)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">AND (WI  &lt;= 1.4 OR WI IS NULL)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">AND (Site_EUI &lt;= 180 OR Site_EUI IS NULL)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>job<span style="color:#f92672">.</span>result()
</span></span></code></pre></div><pre><code>&lt;google.cloud.bigquery.table._EmptyRowIterator at 0x7f89ea923a10&gt;
</code></pre>
<p>We can see the total number of buidlings we have removed as outliers:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>num_rows <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>query(<span style="color:#e6db74">&#34;SELECT COUNT(1) FROM db_gb.no_outlier_data&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> num_rows<span style="color:#f92672">.</span>result():
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Total Buildings in without ouliers: &#34;</span>, row[<span style="color:#ae81ff">0</span>])
</span></span></code></pre></div><pre><code>Total Buildings in without ouliers:  9263
</code></pre>
<p>And compare to the oringal number of buildings:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Total Buildings in original data: </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>format(X<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]))
</span></span></code></pre></div><pre><code>Total Buildings in original data: 9932
</code></pre>
<p>We can see that we removed 669 buildings or a little less than 7%, which is a little high, but given this is self reported data it&rsquo;s not entirely unreasonable.</p>
<h2 id="recommendations--next-steps">
  Recommendations &amp; Next Steps <a class="anchor" id="sixth-bullet"></a>
  <a class="heading-link" href="#recommendations--next-steps">
    <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<hr>
<p>In this first of a series blog post we analyzed the energy usage of buildings in New York City.  From the final heat map of the correlation matrix we can see that the Energy Star score is negatively correlated with enery usage intensity.  This makes sense as the energy star score is a measure of energy efficiceny of the building. The energy usage intensity has a strong positive correlation to the natural gas usage intensity.  We can see that natural gas usage intensity and electricity usage intensity are uncorrlated.  This implies we could replace one with the other.  Therefore reducing natural gas consumption or replacing it with electricity could be the best answer to reducing energy usage intensity and green house gas emissions.  It should also be noted that year the residence was built did not have any correlation with energy usage intensity. This is probably due to the fact that the majority of residential buildings in New York City were built in a similar time period and before energy efficiency was a priority.</p>
<p>Since natural gas usage intensity is most highly correlated with energy usage intensity reducing it could improve building energy efficiency and reduce green house gas emissions (so long as the buildings&rsquo; electricity comes from a clean energy source or atleast one with less emissions than natural gas). Some ways to reduce natural gas consumption include:</p>
<ul>
<li>
<p>Investing in more efficient heating and cooling services or slightly reducing the usage of either heating or cooling during the day when most people are not home. This is especially important in large buildings as HVAC systems have a larger volume of air to heat/cool.</p>
</li>
<li>
<p>Another option is to reuse waste heat, such as reusing the vented air from electric clothes dryers, however, filtering and the air will be necessary and could alter the cost effectiveness of this approach.</p>
</li>
<li>
<p>Replacing gas powered appliances such as stoves with more efficient electric ones is another option.  However, the source of electric power should also be considered to weigh the overall energy efficiency and enviromental impact.</p>
</li>
<li>
<p>Another option is to replace gas powered water heaters by solar powered water heaters. While solar powered water heaters are not as cost effective in moderate climates, the presence of numerous roof top water tanks on New York City buildings may help make this option more financially competitive.  At the very least, it suggests that having roof top water tanks for solar powered water heaters is structurally possible, where as with individual houses this may not be the feasible.</p>
</li>
<li>
<p>In addition, buying energy efficient refrigerators and dryers is also important as these are two of the largest energy consumers in ones home.</p>
</li>
</ul>
<p>We saw that there were a lot of fields in the dataset with missing values.  In the next blogpost we will go over the steps to how to impute these missing values.</p>

      </div>


      <footer>
        

<section class="see-also">
  
    
    
    
      <h3 id="see-also-in-scikit-learn">
        See also in Scikit-Learn
        <a class="heading-link" href="#see-also-in-scikit-learn">
          <i class="fa-solid fa-link" aria-hidden="true" title="Link to heading"></i>
          <span class="sr-only">Link to heading</span>
        </a>
      </h3>
      <nav>
        <ul>
        
        
          
            <li>
              <a href="/posts/kmeans/">Writing A Scikit Learn Compatible Clustering Algorithm</a>
            </li>
          
        
          
            <li>
              <a href="/posts/greenbuildings3/">Green Buildings 3: Build &amp; Deploy Models With MLflow &amp; Docker</a>
            </li>
          
        
          
            <li>
              <a href="/posts/greenbuildings2/">Green Buildings 2: Imputing Missing Values With Scikit-Learn</a>
            </li>
          
        
          
        
        </ul>
      </nav>
    
  
</section>


        
        
        
        
        
        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
      2016 -
    
    2025
     Mike Harmon 
    ·
    
    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/" target="_blank" rel="noopener">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.js"></script>
  

  

  


  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
</body>
</html>
